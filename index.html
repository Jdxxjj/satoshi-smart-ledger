<!-- ======== PART 1/7: HEAD + GLOBAL STYLE (Stable UI v3) ======== -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Satoshi Smart Ledger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ===== Global Layout & Theme ===== */
    body{font-family:"Prompt","Tahoma",sans-serif;margin:0;background:#f5f6fa;color:#2f3640;}
    /* ---------- HEADER TABS ---------- */
    .tabs{display:flex;background:#1f2937;border-bottom:3px solid #B27A01;flex-wrap:wrap;}
    .tabs button{flex:1;padding:14px 12px;border:none;background:#1f2937;color:#d1d5db;font-weight:600;cursor:pointer;transition:.25s;letter-spacing:.3px;min-width:120px;}
    .tabs button:hover{background:#374151;color:#fff}
    .tabs button.active{background:#B27A01;color:#fff;font-weight:700}

    /* ---------- PAGE & CARD ---------- */
    .page{display:none;padding:24px}
    .page.active{display:block}
    .card{max-width:1140px;margin:24px auto;background:#fff;border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,.08);padding:28px;transition:.25s;}
    .card:hover{box-shadow:0 6px 20px rgba(0,0,0,.1)}
    h2{margin:0 0 18px;color:#111827;font-size:1.5rem}

    /* ---------- FORM ELEMENTS ---------- */
    label{display:block;margin-top:10px;font-weight:600;font-size:.95rem;color:#374151;}
    input,select{width:100%;padding:12px 14px;margin-top:6px;border:1px solid #d1d5db;border-radius:10px;font-size:1rem;background:#fafafa;transition:.2s;}
    input:focus,select:focus{outline:none;border-color:#B27A01;background:#fff;box-shadow:0 0 0 3px rgba(178,122,1,.18);}
    .error{color:#d93025;font-size:.85rem;margin-top:4px;min-height:18px}
    .error-input{border-color:#d93025!important}

    /* ---------- GRID SYSTEM ---------- */
    .row{display:flex;flex-wrap:wrap;gap:16px;margin-top:8px;}
    .row > div{flex:1;min-width:260px;}
    .full{flex:100%}
    @media(max-width:780px){.row{flex-direction:column;gap:12px}.row>div{min-width:100%}}

    /* ---------- BUTTONS ---------- */
    .btn{padding:10px 16px;border:none;border-radius:10px;cursor:pointer;font-weight:600;transition:.25s;}
    .btn-ok{background:linear-gradient(135deg,#0ea5e9,#0284c7);color:#fff}
    .btn-cancel{background:#ef4444;color:#fff}
    .btn-ok:hover,.btn-cancel:hover{filter:brightness(1.1)}
    .submit{display:block;width:100%;padding:16px;margin-top:24px;border:none;border-radius:12px;background:linear-gradient(135deg,#B27A01,#eab308);color:#fff;font-weight:700;font-size:1.05rem;cursor:pointer;transition:.25s;}
    .submit:hover{box-shadow:0 4px 14px rgba(178,122,1,.3);transform:translateY(-1px);}

    /* ---------- TOGGLE ---------- */
    .toggle{display:flex;gap:12px;margin:18px 0;flex-wrap:wrap;}
    .toggle button{flex:1;padding:14px;border:none;border-radius:12px;font-size:1rem;font-weight:600;background:#e5e7eb;color:#374151;cursor:pointer;transition:.25s;min-width:120px;}
    .toggle button.selected{background:linear-gradient(135deg,#B27A01,#d4a017);color:#fff;box-shadow:0 3px 8px rgba(178,122,1,.3);}

    /* ---------- TAG INPUT ---------- */
    .tag-input{display:flex;flex-wrap:wrap;gap:6px;align-items:center;border:1px solid #d1d5db;border-radius:10px;padding:8px;background:#f9fafb;cursor:text;position:relative;flex:1;min-height:48px;}
    .tag-input input{border:none;outline:none;flex:1;min-width:120px;padding:6px;font-size:.95rem;background:transparent;}
    .tag{display:inline-flex;align-items:center;gap:6px;background:#e2e8f0;color:#111;padding:6px 10px;border-radius:999px;font-size:.9rem;}
    .tag button{border:none;background:transparent;cursor:pointer;color:#555;font-weight:bold;}
    .tag:hover{background:#cbd5e1}
    .suggestion-list{position:absolute;left:0;right:0;top:100%;background:#fff;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.1);max-height:160px;overflow-y:auto;z-index:50;margin-top:2px;}
    .suggestion-item{padding:8px 10px;cursor:pointer}
    .suggestion-item:hover{background:#f1f5f9}

    /* ---------- UPLOAD ---------- */
    .upload-row{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap;}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#f1f5f9;border:1px solid #e2e8f0;color:#0f172a;padding:6px 10px;border-radius:999px;font-size:.85rem;cursor:pointer;text-decoration:none;}
    .chip:hover{background:#e2e8f0}

    /* ---------- POPUP ---------- */
    #popup{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:2000;justify-content:center;align-items:center;}
    #popupBox{background:#fff;padding:24px 28px;border-radius:12px;font-size:1.2rem;box-shadow:0 4px 12px rgba(0,0,0,.2);}
  </style>
</head>
<!-- ======== PART 2/7: TABS + ADD PAGE (Form เบิก-จ่าย) ======== -->
<body>
  <div class="tabs">
    <button class="tab active" data-id="add">เพิ่มรายการ</button>
    <button class="tab" data-id="history">ประวัติ</button>
    <button class="tab" data-id="dashboard">แดชบอร์ด</button>
  </div>
  <!-- ADD PAGE -->
  <section id="add" class="page active">
    <div class="card">
      <h2>เพิ่มรายการ</h2>
      <div class="toggle">
        <button type="button" id="btnIncome">เบิก</button>
        <button type="button" id="btnExpense">จ่าย</button>
      </div>
      <!-- ฟอร์มหลัก -->
      <form id="form" novalidate>
        <input type="hidden" id="mode">
        <!-- วันที่ + รายละเอียด -->
        <div class="row">
          <div>
            <label>วันที่</label>
            <input type="date" id="date" required>
            <div class="error" id="err-date"></div>
          </div>
          <div id="itemWrap" class="expense-only" style="display:none">
            <label>รายละเอียด</label>
            <input type="text" id="item" placeholder="เช่น เหล็กเส้น SD40 Ø16 mm">
            <div class="error" id="err-item"></div>
          </div>
        </div>
        <!-- ร้านค้า -->
        <div id="supplierExpenseWrap" class="full" style="display:none">
          <label>ร้านค้า</label>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <select id="supplierExpense" style="flex:1;min-width:200px"></select>
            <button type="button" id="addSupplierBtn" class="btn btn-ok">+ เพิ่มร้านค้าใหม่</button>
          </div>
          <div class="error" id="err-supplierExpense"></div>
        </div>
<!-- ======== PART 3/7: HISTORY PAGE + DASHBOARD + POPUP ======== -->

<!-- HISTORY PAGE -->
<section id="history" class="page">
  <div class="card">
    <h2>ประวัติการทำรายการ</h2>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;align-items:center">
      <input type="text" id="searchBox" placeholder="ค้นหารายการ..." style="flex:2;padding:10px;border:1px solid #ccc;border-radius:8px">
      <input type="date" id="filterStart" style="padding:10px;border:1px solid #ccc;border-radius:8px">
      <span>ถึง</span>
      <input type="date" id="filterEnd" style="padding:10px;border:1px solid #ccc;border-radius:8px">
      <select id="filterMode" style="flex:1;padding:10px;border:1px solid #ccc;border-radius:8px">
        <option value="">ทั้งหมด</option>
        <option value="เบิก">เบิก</option>
        <option value="จ่าย">จ่าย</option>
      </select>
      <select id="sortBy" style="flex:1;padding:10px;border:1px solid #ccc;border-radius:8px">
        <option value="date_desc">วันที่ (ใหม่→เก่า)</option>
        <option value="date_asc">วันที่ (เก่า→ใหม่)</option>
        <option value="amount_desc">จำนวนเงิน (มาก→น้อย)</option>
        <option value="amount_asc">จำนวนเงิน (น้อย→มาก)</option>
        <option value="operator_asc">ผู้ดำเนินการ (A→Z)</option>
        <option value="operator_desc">ผู้ดำเนินการ (Z→A)</option>
      </select>
      <button id="applyDateFilter" class="btn btn-ok">กรอง</button>
      <button id="resetDateFilter" class="btn btn-cancel">ล้าง</button>
    </div>

    <div id="historyList"></div>
    <div style="text-align:center;margin-top:12px">
      <button id="loadMoreBtn" class="btn btn-ok">โหลดเพิ่ม</button>
    </div>
  </div>
</section>

<!-- DASHBOARD PAGE -->
<section id="dashboard" class="page">
  <div class="card">
    <h2>แดชบอร์ด</h2>

    <div class="filter-row" style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:14px;align-items:center">
      <input type="date" id="dbStart" class="mini" style="padding:10px;border:1px solid #ccc;border-radius:8px">
      <input type="date" id="dbEnd" class="mini" style="padding:10px;border:1px solid #ccc;border-radius:8px">
      <select id="dbPreset" class="mini" style="padding:10px;border:1px solid #ccc;border-radius:8px">
        <option value="">ตั้งค่าช่วงเวลา</option>
        <option value="this_month">เดือนนี้</option>
        <option value="last_month">เดือนที่แล้ว</option>
        <option value="this_year">ปีนี้</option>
        <option value="last_year">ปีที่แล้ว</option>
      </select>
      <button class="btn btn-ok" id="dbApply">นำไปใช้</button>
      <button class="btn btn-cancel" id="dbReset">ล้างตัวกรอง</button>
    </div>

    <div class="crumbs" id="dbCrumbs"></div>
    <button class="btn btn-ok btn-back" id="dbBack" style="display:none">ย้อนกลับ</button>
    <div class="dash" style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div id="donutWrap"><canvas id="donutChart"></canvas></div>
      <div class="summary" id="summaryBox"></div>
    </div>
  </div>
</section>

<div id="popup"><div id="popupBox">กำลังบันทึก...</div></div>
<!-- ======== PART 4/7: SCRIPT – GLOBAL, HELPERS, TABS, MODE, TAG+SUGGESTION ======== -->
<script>
const API_URL = "https://satoshi-smart-ledger.tttta2556.workers.dev/";
let records = [], chart = null;
let preUploaded = { slips: [], receipts: [] };
let selectedBuildings = [], buildingList = [];

/* ===== Helpers ===== */
function ymd(d){const dt=new Date(d);return isNaN(dt)?null:dt.toISOString().slice(0,10);}
function formatDate(d){if(!d)return"";const dt=new Date(d);return ("0"+dt.getDate()).slice(-2)+"/"+("0"+(dt.getMonth()+1)).slice(-2)+"/"+dt.getFullYear();}
function todayYMD(){return new Date().toISOString().slice(0,10);}
function showPopup(m){document.getElementById("popupBox").innerText=m;document.getElementById("popup").style.display="flex";}
function hidePopup(){document.getElementById("popup").style.display="none";}

/* ===== Load Options ===== */
async function loadOptions(){
  try{
    const r=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"loadOptions"})});
    const j=await r.json();
    const fill=(id,arr,ph="-- เลือก --")=>{
      const el=document.getElementById(id);
      if(!el)return;
      el.innerHTML=`<option value="">${ph}</option>`+(arr||[]).map(v=>`<option>${v}</option>`).join("");
    };
    fill("supplierExpense",j.suppliers,"-- เลือกร้านค้า --");
    fill("project",j.projects,"-- เลือกโครงการ --");
    fill("jobType",j.jobTypes,"-- เลือกประเภทงาน --");
    fill("category",j.categories,"-- เลือกหมวดงาน --");
    fill("paymentType",j.paymentTypes,"-- เลือกประเภทรายการจ่าย --");
    buildingList=j.buildings||[];
  }catch(e){buildingList=[];}
}

/* ===== Load Records ===== */
async function loadRecords(){
  try{
    const r=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"list"})});
    const j=await r.json();
    records=Array.isArray(j.data)?j.data:[];
  }catch(e){records=[];}
}

/* ===== Tabs ===== */
document.querySelectorAll(".tab").forEach(b=>{
  b.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    document.querySelectorAll(".page").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    document.getElementById(b.dataset.id).classList.add("active");
    if(b.dataset.id==="history") renderHistory();
    if(b.dataset.id==="dashboard") renderDashboard();
  });
});

/* ===== Toggle Mode ===== */
function setMode(m){
  document.getElementById("mode").value=m;
  document.getElementById("btnIncome").classList.toggle("selected",m==="เบิก");
  document.getElementById("btnExpense").classList.toggle("selected",m==="จ่าย");
  const show=(m==="จ่าย");
  document.querySelectorAll(".expense-only").forEach(el=>el.style.display=show?"block":"none");
  document.getElementById("supplierExpenseWrap").style.display=show?"block":"none";
  document.getElementById("filesExpense").style.display=show?"block":"none";
  document.getElementById("itemWrap").style.display=show?"block":"none";
}
document.getElementById("btnIncome").onclick=()=>setMode("เบิก");
document.getElementById("btnExpense").onclick=()=>setMode("จ่าย");
setMode("เบิก");

/* ===== Tag Input ===== */
function renderBuildingTags(){
  const box=document.getElementById("buildingTags");
  const input=document.getElementById("buildingInput");
  box.querySelectorAll(".tag").forEach(el=>el.remove());
  selectedBuildings.forEach((b,i)=>{
    const tag=document.createElement("div");
    tag.className="tag";
    tag.innerHTML=`${b} <button type="button" onclick="removeBuilding(${i})">×</button>`;
    box.insertBefore(tag,input);
  });
}
function removeBuilding(i){selectedBuildings.splice(i,1);renderBuildingTags();}
function renderBuildingSuggestions(q=""){
  const list=document.getElementById("buildingSuggest");
  list.innerHTML="";
  const filtered=(buildingList||[]).filter(b=>b.toLowerCase().includes(q.toLowerCase())&&!selectedBuildings.includes(b)).slice(0,8);
  if(!filtered.length){list.style.display="none";return;}
  filtered.forEach(b=>{
    const it=document.createElement("div");
    it.className="suggestion-item";
    it.textContent=b;
    it.onclick=()=>{selectedBuildings.push(b);renderBuildingTags();document.getElementById("buildingInput").value="";list.style.display="none";};
    list.appendChild(it);
  });
  list.style.display="block";
}
document.getElementById("buildingInput").oninput=e=>renderBuildingSuggestions(e.target.value.trim());
document.getElementById("buildingInput").onkeydown=e=>{
  if(e.key==="Enter"&&e.target.value.trim()!==""){e.preventDefault();const v=e.target.value.trim();if(!selectedBuildings.includes(v))selectedBuildings.push(v);e.target.value="";renderBuildingTags();document.getElementById("buildingSuggest").style.display="none";}
};
document.addEventListener("click",e=>{const box=document.getElementById("buildingTags");if(!box.contains(e.target))document.getElementById("buildingSuggest").style.display="none";});
</script>
<!-- ======== PART 5/7: VALIDATION + UPLOAD + SUBMIT ======== -->
<script>
/* ===== Validation ===== */
function clearErrors(){
  document.querySelectorAll(".error").forEach(e=>e.textContent="");
  document.querySelectorAll("input,select").forEach(el=>el.classList.remove("error-input"));
}
function showError(id,msg){
  const el=document.getElementById(id);
  const err=document.getElementById("err-"+id);
  if(err) err.textContent=msg||"กรอกข้อมูลให้ครบ";
  if(el) el.classList.add("error-input");
}
function validateForm(){
  clearErrors();
  let ok=true;
  const mode=document.getElementById("mode").value;
  const date=document.getElementById("date").value;
  const amountRaw=(document.getElementById("amount").value||"").replace(/,/g,"");
  const amount=parseFloat(amountRaw);
  const operator=document.getElementById("operator").value;
  if(!date){showError("date","กรุณาเลือกวันที่");ok=false;}
  if(isNaN(amount)){showError("amount","กรุณากรอกจำนวนเงิน");ok=false;}
  if(!operator){showError("operator","กรุณาเลือกผู้ดำเนินการ");ok=false;}
  if(mode==="จ่าย"){
    const need=[["item","กรุณากรอกรายละเอียด"],["supplierExpense","กรุณาเลือกร้านค้า"],["project","กรุณาเลือกโครงการ"],["jobType","กรุณาเลือกประเภทงาน"],["category","กรุณาเลือกหมวดงาน"],["paymentType","กรุณาเลือกประเภทรายการจ่าย"]];
    need.forEach(([id,msg])=>{if(!document.getElementById(id).value){showError(id,msg);ok=false;}});
    if(selectedBuildings.length===0){showError("building","กรุณาเลือก/เพิ่มอาคาร");ok=false;}
  }
  return ok;
}

/* ===== Upload ===== */
function fileToBase64(f){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result.split(",")[1]);r.onerror=rej;r.readAsDataURL(f);});}
async function uploadBase64(action,b64,mime,filename){
  const r=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action,data:b64,mimeType:mime,filename})});
  const j=await r.json();if(!j.ok) throw new Error("upload failed");return j.url;
}
async function preUpload(inputEl,type){
  const files=Array.from(inputEl.files||[]);if(!files.length)return[];
  const status=document.getElementById(type+"Status");const chips=document.getElementById(type+"Chips");
  status.textContent="กำลังอัปโหลด...";chips.innerHTML="";
  const urls=[];
  for(let i=0;i<files.length;i++){
    const f=files[i];const b64=await fileToBase64(f);
    const act=(type==="slip")?"uploadSlip":"uploadReceipt";
    const url=await uploadBase64(act,b64,f.type,f.name);
    urls.push(url);
    const chip=document.createElement("a");
    chip.className="chip";chip.href=url;chip.target="_blank";
    chip.textContent=(type==="slip"?"สลิป":"ใบเสร็จ")+(files.length>1?(" "+(i+1)):"");
    chips.appendChild(chip);
  }
  status.textContent="อัปโหลดเสร็จสิ้น";return urls;
}
document.getElementById("slipExpense").onchange=async e=>{
  try{preUploaded.slips=await preUpload(e.target,"slip");}
  catch{document.getElementById("slipStatus").textContent="อัปโหลดล้มเหลว";}
};
document.getElementById("receiptExpense").onchange=async e=>{
  try{preUploaded.receipts=await preUpload(e.target,"receipt");}
  catch{document.getElementById("receiptStatus").textContent="อัปโหลดล้มเหลว";}
};

/* ===== Submit ===== */
document.getElementById("form").addEventListener("submit",async e=>{
  e.preventDefault();
  if(!validateForm())return;
  const mode=document.getElementById("mode").value;
  const date=document.getElementById("date").value;
  const amount=parseFloat((document.getElementById("amount").value||"").replace(/,/g,""));
  const operator=document.getElementById("operator").value;
  const buildings=selectedBuildings.slice();
  const slips=preUploaded.slips.slice();
  const receipts=preUploaded.receipts.slice();
  const split=(mode==="จ่าย"&&buildings.length>0)?(amount/buildings.length):amount;

  const payloads=[];
  if(mode==="จ่าย"&&buildings.length>0){
    for(const b of buildings){
      payloads.push({
        mode,date,item:document.getElementById("item").value,
        supplier:document.getElementById("supplierExpense").value,
        project:document.getElementById("project").value,
        building:[b],
        jobType:document.getElementById("jobType").value,
        category:document.getElementById("category").value,
        paymentType:document.getElementById("paymentType").value,
        amount:-Math.abs(split),operator,slips,receipts
      });
    }
  }else{
    payloads.push({mode,date,item:"",supplier:"",project:"",building:[],jobType:"",category:"",paymentType:"",amount:Math.abs(amount),operator,slips,receipts});
  }

  showPopup(`กำลังบันทึก (${payloads.length} รายการ)...`);
  try{
    for(const p of payloads){
      const res=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});
      const j=await res.json();if(!j.ok) throw new Error();
    }
    showPopup("บันทึกสำเร็จ");setTimeout(hidePopup,1200);
    document.getElementById("form").reset();
    preUploaded={slips:[],receipts:[]};
    document.getElementById("slipStatus").textContent="ยังไม่ได้อัปโหลด";
    document.getElementById("receiptStatus").textContent="ยังไม่ได้อัปโหลด";
    document.getElementById("slipChips").innerHTML="";
    document.getElementById("receiptChips").innerHTML="";
    selectedBuildings=[];renderBuildingTags();setMode("เบิก");
    await loadOptions();await loadRecords();
  }catch(err){showPopup("บันทึกล้มเหลว");setTimeout(hidePopup,1500);}
});
</script>
<!-- ======== PART 6/7: HISTORY LOGIC ======== -->
<script>
let historyPage={page:1,perPage:12,filtered:[]};

function applyFilters(){
  const q=(document.getElementById("searchBox").value||"").toLowerCase();
  const mode=document.getElementById("filterMode").value;
  const sort=document.getElementById("sortBy").value;
  const start=document.getElementById("filterStart").value;
  const end=document.getElementById("filterEnd").value;
  let arr=records.filter(r=>{
    const s=[r.item,r.supplier,r.project,r.operator].join(" ").toLowerCase();
    if(q&&!s.includes(q))return false;
    if(mode&&r.mode!==mode)return false;
    const d=ymd(r.date);
    if(start&&(d<start))return false;
    if(end&&(d>end))return false;
    return true;
  });
  if(sort==="date_desc")arr.sort((a,b)=>new Date(b.date)-new Date(a.date));
  if(sort==="date_asc")arr.sort((a,b)=>new Date(a.date)-new Date(b.date));
  if(sort==="amount_desc")arr.sort((a,b)=>b.amount-a.amount);
  if(sort==="amount_asc")arr.sort((a,b)=>a.amount-b.amount);
  historyPage.filtered=arr;historyPage.page=1;
  renderHistoryList();
}

function renderHistoryList(){
  const list=document.getElementById("historyList");
  list.innerHTML="";
  const end=historyPage.page*historyPage.perPage;
  const show=historyPage.filtered.slice(0,end);
  const groups={};
  show.forEach(r=>{
    const k=ymd(r.date)||"";if(!groups[k])groups[k]=[];groups[k].push(r);
  });
  Object.keys(groups).sort((a,b)=>new Date(b)-new Date(a)).forEach(d=>{
    const head=document.createElement("div");
    head.textContent=formatDate(d);
    head.style="font-weight:600;margin-top:14px";
    list.appendChild(head);
    groups[d].forEach(r=>{
      const card=document.createElement("div");
      const inc=r.mode==="เบิก";
      const money=(inc?"+":"-")+Math.abs(r.amount||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})+" บาท";
      card.style=`border-left:6px solid ${inc?"#06c755":"#d93025"};background:#fff;margin:6px 0;border-radius:10px;padding:10px 14px;box-shadow:0 2px 6px rgba(0,0,0,0.05);`;
      card.innerHTML=`<div style="display:flex;justify-content:space-between"><b>${r.item||"-"}</b><span style="color:${inc?'#16a34a':'#dc2626'}">${money}</span></div>
      <div style="font-size:.9rem;color:#555">${r.project||"-"} | ${r.operator||"-"} (${r.mode})</div>`;
      list.appendChild(card);
    });
  });
  document.getElementById("loadMoreBtn").style.display=(historyPage.filtered.length>end)?"inline-block":"none";
}

document.getElementById("applyDateFilter").onclick=applyFilters;
document.getElementById("resetDateFilter").onclick=()=>{document.getElementById("filterStart").value="";document.getElementById("filterEnd").value="";applyFilters();};
document.getElementById("searchBox").oninput=applyFilters;
document.getElementById("filterMode").onchange=applyFilters;
document.getElementById("sortBy").onchange=applyFilters;
document.getElementById("loadMoreBtn").onclick=()=>{historyPage.page++;renderHistoryList();};
function renderHistory(){applyFilters();}
</script>
<!-- ======== PART 7/7: AMOUNT INPUT HANDLER ======== -->
<script>
const amountEl=document.getElementById("amount");
const amountTxt=document.getElementById("amountTxt");

/* ===== แปลงตัวเลขเป็นข้อความไทย ===== */
function thaiMoneyText(intPart,decPart){
  const t=["ศูนย์","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"];
  const u=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];
  function readNum(num){
    if(!num||+num===0)return"";
    let s="",arr=String(+num).split("").reverse();
    for(let i=arr.length-1;i>=0;i--){
      const n=+arr[i];
      if(n!==0){
        if(i===1&&n===1)s+="สิบ";
        else if(i===1&&n===2)s+="ยี่สิบ";
        else if(i===0&&n===1&&arr.length>1)s+="เอ็ด";
        else s+=t[n]+u[i];
      }
    }return s;
  }
  const baht=(intPart&&+intPart>0)?readNum(intPart)+"บาท":"ศูนย์บาท";
  const satang=(decPart&&+decPart>0)?readNum(decPart)+"สตางค์":"ถ้วน";
  return baht+satang;
}

/* ===== ฟอร์แมตจำนวนเงิน ===== */
amountEl.addEventListener("input",()=>{
  const start=amountEl.selectionStart,end=amountEl.selectionEnd;
  let raw=amountEl.value.replace(/[^\d.]/g,"");
  const parts=raw.split(".");
  if(parts.length>2)raw=parts[0]+"."+parts.slice(1).join("");
  let[intPart,decPart=""]=raw.split(".");
  if(intPart.length>1)intPart=intPart.replace(/^0+(?=\d)/,"");
  const intWithComma=intPart.replace(/\B(?=(\d{3})+(?!\d))/g,",");
  amountEl.value=decPart!==""?`${intWithComma}.${decPart}`:intWithComma;
  const num=parseFloat(raw);
  if(!isNaN(num)){
    const[i,d]=num.toFixed(2).split(".");
    amountTxt.textContent="("+thaiMoneyText(i,d)+")";
  }else amountTxt.textContent="";
  try{amountEl.setSelectionRange(start,end);}catch{}
});
amountEl.addEventListener("blur",()=>{
  const raw=amountEl.value.replace(/,/g,"");
  const num=parseFloat(raw);
  if(!isNaN(num)){
    const formatted=num.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});
    amountEl.value=formatted;
    const[i,d]=num.toFixed(2).split(".");
    amountTxt.textContent="("+thaiMoneyText(i,d)+")";
  }else{amountEl.value="";amountTxt.textContent="";}
});
</script>
</body>
</html>
