<!-- ======== PART 1/7 (UPDATED UI BUTTONS) ======== -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Satoshi Smart Ledger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Base */
    body{font-family:"Tahoma",Arial,sans-serif;margin:0;background:#f8f9fb;color:#333}
    .tabs{display:flex;background:#222}
    .tabs button{flex:1;padding:16px;border:none;background:#333;color:#bbb;cursor:pointer;transition:.25s;font-weight:500;letter-spacing:.3px}
    .tabs button:hover{background:#444;color:#fff}
    .tabs button.active{background:#B27A01;color:#fff;font-weight:700;box-shadow:inset 0 -3px 0 #fff}
    .page{display:none;padding:20px}
    .page.active{display:block}
    .card{max-width:1140px;margin:20px auto;background:#fff;border-radius:16px;box-shadow:0 4px 14px rgba(0,0,0,.08);padding:28px;transition:.3s}
    h2{margin:0 0 16px;color:#222;font-size:1.35rem}
    label{display:block;margin-top:14px;font-weight:600;font-size:.95rem;color:#444}
    input,select{width:100%;padding:12px 14px;margin-top:6px;border:1px solid #ddd;border-radius:10px;font-size:1rem;box-sizing:border-box;background:#fafafa;transition:.2s}
    input:focus,select:focus{outline:none;border-color:#B27A01;background:#fff;box-shadow:0 0 0 3px rgba(178,122,1,.2)}
    .hint{font-size:.85rem;color:#64748b;margin-top:6px}
    .error{color:#d93025;font-size:.85rem;margin-top:4px;min-height:18px}
    .error-input{border-color:#d93025 !important}

    /* Toggle buttons (เบิก/จ่าย) */
    .toggle{display:flex;gap:0;margin:18px 0;overflow:hidden;border-radius:14px;border:1px solid #ccc;width:max-content}
    .toggle button{flex:1;padding:12px 24px;border:none;background:#f1f5f9;color:#444;cursor:pointer;transition:.2s;font-size:1rem;font-weight:600}
    .toggle button:first-child{border-right:1px solid #ddd}
    .toggle button:hover{background:#e2e8f0}
    .toggle button.selected{background:#B27A01;color:#fff;font-weight:700;box-shadow:0 2px 6px rgba(178,122,1,.3)}

    /* Main submit buttons */
    .submit,.btn-ok,.btn{padding:13px 18px;border:none;border-radius:12px;font-size:1rem;font-weight:600;cursor:pointer;transition:.25s;letter-spacing:.2px}
    .submit{margin-top:24px;width:100%;background:#B27A01;color:#fff;box-shadow:0 3px 8px rgba(178,122,1,.25)}
    .submit:hover{background:#a56e00}
    .btn-ok{background:#B27A01;color:#fff}
    .btn-ok:hover{background:#a56e00;box-shadow:0 3px 8px rgba(178,122,1,.25)}
    .btn-cancel{background:#d93025;color:#fff}
    .btn-cancel:hover{background:#c62820}
    .btn{background:#f1f5f9;color:#444}
    .btn:hover{background:#e2e8f0}

    /* Secondary button layout */
    #addSupplierBtn,#addBuildingBtn{padding:10px 16px;font-size:.95rem;border-radius:10px;white-space:nowrap}
    #addSupplierBtn:hover,#addBuildingBtn:hover{transform:translateY(-1px)}

    /* Filter buttons (แดชบอร์ด) */
    .btn-apply{padding:9px 14px;border:none;border-radius:10px;background:#06c755;color:#fff;font-weight:700;cursor:pointer;transition:.25s}
    .btn-apply:hover{background:#05b64f;box-shadow:0 2px 6px rgba(6,199,85,.25)}
    .btn-back{padding:8px 14px;background:#f1f5f9;border-radius:10px;color:#444;border:none;cursor:pointer}
    .btn-back:hover{background:#e2e8f0}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .full{grid-column:1/-1}
    .amount-display{margin-top:6px;color:#777;font-style:italic}
    @media (max-width:780px){.row{grid-template-columns:1fr}}

    /* Popup */
    #popup{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:2000;justify-content:center;align-items:center}
    #popupBox{background:#fff;padding:24px 28px;border-radius:12px;font-size:1.2rem;box-shadow:0 4px 12px rgba(0,0,0,.2)}

    /* Upload chips */
    .upload-row{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .upload-status{font-size:.9rem;color:#555}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#f1f5f9;border:1px solid #e2e8f0;color:#0f172a;padding:6px 10px;border-radius:999px;font-size:.85rem;cursor:pointer;text-decoration:none;transition:.15s}
    .chip:hover{background:#e2e8f0;transform:translateY(-1px)}
    .chip i{font-style:normal;opacity:.7}

    /* Tag Input (Building) + Suggestion */
    .tag-input{display:flex;flex-wrap:wrap;gap:6px;align-items:center;border:1px solid #ddd;border-radius:10px;padding:8px;background:#fafafa;cursor:text;position:relative;flex:1;transition:.2s}
    .tag-input:focus-within{border-color:#B27A01;box-shadow:0 0 0 2px rgba(178,122,1,.15)}
    .tag-input input{border:none;outline:none;flex:1;min-width:120px;padding:6px;font-size:.95rem;background:transparent}
    .tag{display:inline-flex;align-items:center;gap:6px;background:#e2e8f0;color:#111;padding:6px 10px;border-radius:999px;font-size:.9rem}
    .tag button{border:none;background:transparent;cursor:pointer;color:#555;font-weight:bold}
    .tag button:hover{color:#d93025}
    .suggestion-list{position:absolute;left:0;right:0;top:100%;background:#fff;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.1);max-height:180px;overflow-y:auto;z-index:50;margin-top:2px}
    .suggestion-item{padding:8px 10px;cursor:pointer;transition:.15s}
    .suggestion-item:hover{background:#f1f5f9}
  </style>
</head>
<body>
<!-- ======== END PART 1/7 (UPDATED) ======== -->
<!-- ======== PART 2/7 (UPDATED FORM UI BUTTONS) ======== -->
  <div class="tabs">
    <button class="tab active" data-id="add">เพิ่มรายการ</button>
    <button class="tab" data-id="history">ประวัติ</button>
    <button class="tab" data-id="dashboard">แดชบอร์ด</button>
  </div>

  <!-- ADD PAGE -->
  <section id="add" class="page active">
    <div class="card">
      <h2>เพิ่มรายการ</h2>

      <!-- Toggle -->
      <div class="toggle">
        <button type="button" id="btnIncome">เบิก</button>
        <button type="button" id="btnExpense">จ่าย</button>
      </div>

      <form id="form" novalidate>
        <input type="hidden" id="mode">

        <!-- วันที่ + รายละเอียด -->
        <div class="row">
          <div>
            <label>วันที่</label>
            <input type="date" id="date" required>
            <div class="error" id="err-date"></div>
          </div>
          <div id="itemWrap" class="expense-only" style="display:none">
            <label>รายละเอียด</label>
            <input type="text" id="item" placeholder="ระบุรายละเอียดรายการจ่าย...">
            <div class="error" id="err-item"></div>
          </div>
        </div>

        <!-- ร้านค้า -->
        <div id="supplierExpenseWrap" class="full expense-only" style="display:none">
          <label>ร้านค้า</label>
          <div class="input-row">
            <div style="display:flex;gap:10px;align-items:center;">
              <select id="supplierExpense" style="flex:1"></select>
              <button type="button" id="addSupplierBtn" class="btn-ok">+ เพิ่มร้านค้าใหม่</button>
            </div>
          </div>
          <div class="error" id="err-supplierExpense"></div>
        </div>

        <!-- โครงการ + อาคาร -->
        <div class="row expense-only" style="display:none">
          <div>
            <label>ชื่อโครงการ</label>
            <select id="project"></select>
            <div class="error" id="err-project"></div>
          </div>

          <div>
            <label>อาคาร</label>
            <div style="display:flex;gap:10px;align-items:flex-start;">
              <!-- Tag input + Suggestion -->
              <div id="buildingTags" class="tag-input">
                <input type="text" id="buildingInput" placeholder="พิมพ์ชื่ออาคารหรือเลือกจากลิสต์...">
                <div id="buildingSuggestions" class="suggestion-list" style="display:none;"></div>
              </div>
              <button type="button" id="addBuildingBtn" class="btn-ok">+ เพิ่มอาคารใหม่</button>
            </div>
            <div class="hint">สามารถเลือกหลายอาคาร หรือเพิ่มใหม่ได้</div>
            <div class="error" id="err-building"></div>
          </div>
        </div>

        <!-- ประเภท / หมวด / ประเภทรายการจ่าย -->
        <div class="row expense-only" style="display:none">
          <div>
            <label>ประเภทงาน</label>
            <select id="jobType"></select>
            <div class="error" id="err-jobType"></div>
          </div>
          <div>
            <label>หมวดงาน</label>
            <select id="category"></select>
            <div class="error" id="err-category"></div>
          </div>
        </div>

        <div class="row expense-only" style="display:none">
          <div class="full">
            <label>ประเภทรายการจ่าย</label>
            <select id="paymentType"></select>
            <div class="error" id="err-paymentType"></div>
          </div>
        </div>

        <!-- Upload slips/receipts -->
        <div class="row expense-only" id="filesExpense" style="display:none">
          <div>
            <label>สลิป</label>
            <input type="file" id="slipExpense" multiple accept="image/*,.pdf">
            <div class="upload-row" id="slipStatusRow">
              <span class="upload-status" id="slipStatus">ยังไม่ได้อัปโหลด</span>
              <span id="slipChips"></span>
            </div>
          </div>
          <div>
            <label>ใบเสร็จ</label>
            <input type="file" id="receiptExpense" multiple accept="image/*,.pdf">
            <div class="upload-row" id="receiptStatusRow">
              <span class="upload-status" id="receiptStatus">ยังไม่ได้อัปโหลด</span>
              <span id="receiptChips"></span>
            </div>
          </div>
        </div>

        <!-- Progress bar -->
        <div id="progressWrap">
          <div id="progressBar"><div></div></div>
        </div>

        <!-- จำนวนเงิน + ผู้ดำเนินการ -->
        <div class="row">
          <div>
            <label>จำนวนเงิน</label>
            <input type="text" id="amount" placeholder="เช่น 1,200.50" required>
            <div id="amountTxt" class="amount-display"></div>
            <div class="error" id="err-amount"></div>
          </div>
          <div>
            <label>ผู้ดำเนินการ</label>
            <select id="operator" required>
              <option value="">-- เลือกผู้ดำเนินการ --</option>
              <option>ศุภกร เจิมจรุง</option>
              <option>กฤษณะ ทีมีศรี</option>
              <option>สรัญรุตม์ รอบคอบ</option>
              <option>เจทนิพัทธ์ อนุศาสนนันท์</option>
            </select>
            <div class="error" id="err-operator"></div>
          </div>
        </div>

        <!-- Submit -->
        <button type="submit" id="submitBtn" class="submit">💾 บันทึกรายการ</button>
      </form>
    </div>
  </section>
<!-- ======== END PART 2/7 ======== -->
<!-- ======== PART 3/7 (UPDATED HISTORY + DASHBOARD UI) ======== -->

  <!-- HISTORY PAGE -->
  <section id="history" class="page">
    <div class="card">
      <h2>ประวัติการทำรายการ</h2>

      <!-- Filters bar -->
      <div class="filter-row" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:18px;align-items:center;">
        <input 
          type="text" 
          id="searchBox" 
          placeholder="🔍 ค้นหารายการ..." 
          style="flex:2;padding:10px 14px;border:1px solid #ccc;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05);transition:.2s"
        >
        <select id="filterMode" style="flex:1;padding:10px 14px;border:1px solid #ccc;border-radius:10px;cursor:pointer;">
          <option value="">ทั้งหมด</option>
          <option value="เบิก">เบิก</option>
          <option value="จ่าย">จ่าย</option>
        </select>
        <select id="sortBy" style="flex:1;padding:10px 14px;border:1px solid #ccc;border-radius:10px;cursor:pointer;">
          <option value="date_desc">วันที่ (ใหม่ → เก่า)</option>
          <option value="date_asc">วันที่ (เก่า → ใหม่)</option>
          <option value="amount_desc">จำนวนเงิน (มาก → น้อย)</option>
          <option value="amount_asc">จำนวนเงิน (น้อย → มาก)</option>
          <option value="operator_asc">ผู้ดำเนินการ (A → Z)</option>
          <option value="operator_desc">ผู้ดำเนินการ (Z → A)</option>
        </select>
      </div>

      <!-- History list -->
      <div id="historyList" style="margin-top:10px"></div>

      <!-- Load more -->
      <div style="text-align:center;margin-top:20px">
        <button id="loadMoreBtn" class="btn-ok" style="padding:12px 22px;font-size:1rem;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,.12);">
          ⬇ โหลดเพิ่ม
        </button>
      </div>
    </div>
  </section>

  <!-- DASHBOARD PAGE -->
  <section id="dashboard" class="page">
    <div class="card">
      <h2>แดชบอร์ด</h2>

      <!-- Filters -->
      <div class="filter-row" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:18px;align-items:center;">
        <input type="date" id="dbStart" class="mini" style="padding:9px 12px;border-radius:10px;border:1px solid #ccc;">
        <input type="date" id="dbEnd" class="mini" style="padding:9px 12px;border-radius:10px;border:1px solid #ccc;">
        <select id="dbPreset" class="mini" style="padding:9px 12px;border-radius:10px;border:1px solid #ccc;">
          <option value="">ตั้งค่าช่วงเวลา</option>
          <option value="this_month">เดือนนี้</option>
          <option value="last_month">เดือนที่แล้ว</option>
          <option value="this_year">ปีนี้</option>
          <option value="last_year">ปีที่แล้ว</option>
        </select>

        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn-apply" id="dbApply">✅ นำไปใช้</button>
          <button class="btn" id="dbReset">🔄 ล้างตัวกรอง</button>
        </div>
      </div>

      <!-- Breadcrumbs -->
      <div class="crumbs" id="dbCrumbs" style="margin-bottom:12px;"></div>
      <button class="btn-back" id="dbBack" style="display:none;margin-bottom:12px;">← ย้อนกลับ</button>

      <!-- Dashboard Layout -->
      <div class="dash" style="display:flex;flex-wrap:wrap;gap:24px;align-items:flex-start;justify-content:center;">
        <div id="donutWrap">
          <canvas id="donutChart" style="max-width:420px;max-height:420px;"></canvas>
        </div>
        <div class="summary" id="summaryBox" 
          style="min-width:300px;max-width:520px;flex:1;background:#fff;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.08);padding:20px;">
        </div>
      </div>
    </div>
  </section>
<!-- ======== END PART 3/7 ======== -->
<!-- ======== PART 4/7 (JS INTERACTION FOR HISTORY & DASHBOARD) ======== -->

<script>
/* ========== HISTORY PAGE INTERACTION ========== */
let historyPage = { page: 1, perPage: 12, filtered: [] }

function applyFilters() {
  const q = document.getElementById("searchBox").value.toLowerCase()
  const mode = document.getElementById("filterMode").value
  const sort = document.getElementById("sortBy").value

  let arr = records.filter(r => {
    const s = [r.id, r.item, r.supplier, r.project, r.building, r.operator].join(" ").toLowerCase()
    if (q && !s.includes(q)) return false
    if (mode && r.mode !== mode) return false
    return true
  })

  if (sort === "date_desc") arr.sort((a, b) => new Date(b.date) - new Date(a.date))
  if (sort === "date_asc") arr.sort((a, b) => new Date(a.date) - new Date(b.date))
  if (sort === "amount_desc") arr.sort((a, b) => Math.abs(b.amount) - Math.abs(a.amount))
  if (sort === "amount_asc") arr.sort((a, b) => Math.abs(a.amount) - Math.abs(b.amount))
  if (sort === "operator_asc") arr.sort((a, b) => String(a.operator).localeCompare(String(b.operator)))
  if (sort === "operator_desc") arr.sort((a, b) => String(b.operator).localeCompare(String(a.operator)))

  historyPage.filtered = arr
  historyPage.page = 1
  renderHistoryStatement(true)
}

function renderHistoryStatement(smooth = false) {
  const list = document.getElementById("historyList")
  list.style.opacity = "0"
  setTimeout(() => {
    list.innerHTML = ""
    const end = historyPage.page * historyPage.perPage
    const show = historyPage.filtered.slice(0, end)
    const groups = {}
    show.forEach(r => {
      const k = ymd(r.date) || ""
      if (!groups[k]) groups[k] = []
      groups[k].push(r)
    })

    const today = todayYMD()
    Object.keys(groups).sort((a, b) => new Date(b) - new Date(a)).forEach(d => {
      const title = (d === today) ? "วันนี้" : formatDate(d)
      const header = document.createElement("div")
      header.className = "date-header"
      header.textContent = title
      header.style = "margin:16px 0 8px;font-weight:700;font-size:1.05rem;color:#333;"
      list.appendChild(header)

      groups[d].forEach(r => {
        const isIncome = r.mode === "เบิก"
        const sign = isIncome ? "+" : "-"
        const money = `${sign}${Math.abs(Number(r.amount) || 0).toLocaleString()} บาท`
        const card = document.createElement("div")
        card.className = "history-card"
        card.style = `
          background:#fff;
          border-left:6px solid ${isIncome ? "#06c755" : "#d93025"};
          border-radius:10px;
          box-shadow:0 2px 8px rgba(0,0,0,0.05);
          padding:12px 16px;
          margin-bottom:10px;
          transition:.2s;
          cursor:pointer;
        `
        card.addEventListener("mouseenter", () => card.style.transform = "scale(1.01)")
        card.addEventListener("mouseleave", () => card.style.transform = "scale(1)")

        const slipsArr = (r.slips ? String(r.slips).split(",").filter(Boolean) : [])
        const receiptsArr = (r.receipts ? String(r.receipts).split(",").filter(Boolean) : [])
        const attChips = [
          ...slipsArr.map((u, i) => `<a class="chip" href="${u}" target="_blank"><i>🔗</i>สลิป${slipsArr.length > 1 ? (" " + (i + 1)) : ""}</a>`),
          ...receiptsArr.map((u, i) => `<a class="chip" href="${u}" target="_blank"><i>📄</i>ใบเสร็จ${receiptsArr.length > 1 ? (" " + (i + 1)) : ""}</a>`)
        ].join(" ")

        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <div><b>ID:</b> ${r.id || "-"} • ${formatDate(r.date)} (${r.mode})</div>
            <div style="font-weight:700;color:${isIncome ? "#06c755" : "#d93025"};">${money}</div>
          </div>
          <div>${r.item || "-"}</div>
          <div style="color:#666;font-size:.9rem;margin-top:4px;">ผู้ดำเนินการ: ${r.operator || "-"}</div>
          <div style="margin-top:6px;color:#555;font-size:.9rem;">
            <b>โครงการ:</b> ${r.project || "-"} | <b>อาคาร:</b> ${r.building || "-"}<br>
            <b>ประเภทงาน:</b> ${r.jobType || "-"} | <b>หมวดงาน:</b> ${r.category || "-"}<br>
            <b>ประเภทรายการจ่าย:</b> ${r.paymentType || "-"}
            ${attChips ? `<div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;">${attChips}</div>` : ""}
          </div>
        `
        list.appendChild(card)
      })
    })
    document.getElementById("loadMoreBtn").style.display = (historyPage.filtered.length > end) ? "inline-block" : "none"
    list.style.opacity = "1"
    if (smooth) list.scrollIntoView({ behavior: "smooth", block: "start" })
  }, 100)
}

document.getElementById("searchBox").addEventListener("input", applyFilters)
document.getElementById("filterMode").addEventListener("change", applyFilters)
document.getElementById("sortBy").addEventListener("change", applyFilters)
document.getElementById("loadMoreBtn").addEventListener("click", () => {
  historyPage.page++
  renderHistoryStatement(true)
})

function renderHistory() { applyFilters() }

/* ========== DASHBOARD PAGE INTERACTION ========== */
function renderDrill() {
  const data = filteredData()
  const totalFunds = sumIncome(data)
  const expensesOnly = data.filter(r => r.mode === "จ่าย")

  const ctx = document.getElementById("donutChart").getContext("2d")
  if (chart) chart.destroy()

  const byProject = groupExpense(expensesOnly, "project")
  const spentSum = Object.values(byProject).reduce((a, b) => a + b, 0)
  const remaining = Math.max(totalFunds - spentSum, 0)
  const labels = ["เงินคงเหลือ", ...Object.keys(byProject)]
  const values = [remaining, ...Object.values(byProject)]
  const colors = ["#cbd5e1", ...labels.slice(1).map((_, i) => rndColor(i))]

  chart = new Chart(ctx, {
    type: "doughnut",
    data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
    options: {
      responsive: true,
      cutout: "65%",
      animation: { animateScale: true, animateRotate: true },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.label}: ${Number(ctx.parsed).toLocaleString()} บาท`
          }
        }
      }
    }
  })

  // Smooth render for summary
  const box = document.getElementById("summaryBox")
  box.style.opacity = "0"
  setTimeout(() => {
    box.innerHTML = `
      <h3 style="margin-bottom:12px;">ภาพรวม (100% = เงินเบิกรวม)</h3>
      ${labels.map((label, i) => `
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
          <div style="width:14px;height:14px;background:${colors[i]};border-radius:4px;"></div>
          <span>${label}</span>
          <b style="margin-left:auto">${Number(values[i]).toLocaleString()} บาท</b>
        </div>
      `).join("")}
    `
    box.style.opacity = "1"
  }, 150)
}
</script>
<!-- ======== END PART 4/7 ======== -->
<!-- ======== PART 5/7 (JS SUBMIT WITH AUTO SPLIT PER BUILDING) ======== -->

<script>
/* ========== SUBMIT FORM (UPDATED: MULTI-BUILDING SPLIT) ========== */
document.getElementById("form").addEventListener("submit", async e => {
  e.preventDefault();
  if (!validateForm()) return;

  const mode = document.getElementById("mode").value;
  const date = document.getElementById("date").value;
  const amountRaw = (document.getElementById("amount").value || "").replace(/,/g, "");
  const amount = parseFloat(amountRaw);
  const operator = document.getElementById("operator").value;
  const buildingSelected = selectedBuildings.slice();

  slips = preUploaded.slips.slice();
  receipts = preUploaded.receipts.slice();

  // ถ้าเป็น "เบิก" → บันทึกเดียว
  // ถ้าเป็น "จ่าย" → แยกบันทึกตามจำนวนอาคาร
  let payloads = [];

  if (mode === "เบิก") {
    payloads.push({
      mode,
      date,
      item: "",
      supplier: "",
      project: "",
      building: [],
      jobType: "",
      category: "",
      paymentType: "",
      amount: Math.abs(amount),
      operator,
      slips,
      receipts
    });
  } else {
    const divided = amount / buildingSelected.length;
    buildingSelected.forEach(b => {
      payloads.push({
        mode,
        date,
        item: document.getElementById("item").value,
        supplier: document.getElementById("supplierExpense").value,
        project: document.getElementById("project").value,
        building: [b],
        jobType: document.getElementById("jobType").value,
        category: document.getElementById("category").value,
        paymentType: document.getElementById("paymentType").value,
        amount: -parseFloat(divided.toFixed(2)),
        operator,
        slips,
        receipts
      });
    });
  }

  showPopup(`กำลังบันทึก (${payloads.length} รายการ)...`);
  let success = 0;

  for (let i = 0; i < payloads.length; i++) {
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payloads[i])
      });
      const j = await res.json();
      if (j.ok) success++;
      showPopup(`บันทึกสำเร็จ ${success}/${payloads.length}`);
    } catch {
      showPopup(`เกิดข้อผิดพลาดที่รายการ ${i + 1}`);
    }
  }

  if (success === payloads.length) {
    showPopup("บันทึกสำเร็จทั้งหมด ✅");
  } else {
    showPopup(`บันทึกสำเร็จ ${success}/${payloads.length} รายการ ❗`);
  }

  setTimeout(hidePopup, 1800);

  // Reset form
  document.getElementById("form").reset();
  preUploaded = { slips: [], receipts: [] };
  document.getElementById("slipStatus").textContent = "ยังไม่ได้อัปโหลด";
  document.getElementById("receiptStatus").textContent = "ยังไม่ได้อัปโหลด";
  document.getElementById("slipChips").innerHTML = "";
  document.getElementById("receiptChips").innerHTML = "";
  selectedBuildings = [];
  renderBuildingTags();
  setMode("เบิก");
  await loadOptions();
});
</script>

<!-- ======== END PART 5/7 ======== -->
<!-- ======== PART 6/7 (UPLOAD + VALIDATION + AMOUNT FORMAT) ======== -->

<script>
/* ========== VALIDATION ========== */
function clearErrors() {
  document.querySelectorAll(".error").forEach(e => e.textContent = "");
  document.querySelectorAll("input, select").forEach(el => el.classList.remove("error-input"));
}

function showError(inputId, msg) {
  const el = document.getElementById(inputId);
  const err = document.getElementById("err-" + inputId);
  if (err) err.textContent = msg || "กรอกข้อมูลให้ครบ";
  if (el) el.classList.add("error-input");
  if (el && typeof el.scrollIntoView === "function") {
    el.scrollIntoView({ behavior: "smooth", block: "center" });
  }
}

function validateForm() {
  clearErrors();
  let ok = true;
  const mode = document.getElementById("mode").value;
  const date = document.getElementById("date").value;
  const amountRaw = (document.getElementById("amount").value || "").replace(/,/g, "");
  const amount = parseFloat(amountRaw);
  const operator = document.getElementById("operator").value;

  if (!date) { showError("date", "กรุณาเลือกวันที่"); ok = false; }
  if (isNaN(amount) || amount <= 0) { showError("amount", "กรุณากรอกจำนวนเงินให้ถูกต้อง"); ok = false; }
  if (!operator) { showError("operator", "กรุณาเลือกผู้ดำเนินการ"); ok = false; }

  if (mode === "จ่าย") {
    const need = [
      ["item", "กรุณากรอกรายละเอียด"],
      ["supplierExpense", "กรุณาเลือกร้านค้า"],
      ["project", "กรุณาเลือกโครงการ"],
      ["jobType", "กรุณาเลือกประเภทงาน"],
      ["category", "กรุณาเลือกหมวดงาน"],
      ["paymentType", "กรุณาเลือกประเภทรายการจ่าย"]
    ];
    need.forEach(([id, msg]) => {
      const v = document.getElementById(id).value;
      if (!v) { showError(id, msg); ok = false; }
    });

    if (selectedBuildings.length === 0) {
      showError("building", "กรุณาเลือกอาคารอย่างน้อย 1 รายการ");
      ok = false;
    }
  }

  return ok;
}

/* ========== FILE UPLOAD SYSTEM ========== */
function fileToBase64(file) {
  return new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = () => res(fr.result.split(",")[1]);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}

async function uploadBase64(action, base64, mimeType, filename) {
  const r = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action, data: base64, mimeType, filename })
  });
  const j = await r.json();
  if (!j.ok) throw new Error("upload failed");
  return j.url;
}

async function preUpload(inputEl, type) {
  const files = Array.from(inputEl.files || []);
  if (files.length === 0) return [];

  const statusEl = document.getElementById(type + "Status");
  const chipsEl = document.getElementById(type + "Chips");
  const progress = document.getElementById("progressWrap");
  const bar = progress.querySelector("div");

  statusEl.textContent = "กำลังอัปโหลด...";
  chipsEl.innerHTML = "";
  progress.style.display = "block";

  const urls = [];
  for (let i = 0; i < files.length; i++) {
    const f = files[i];
    const b64 = await fileToBase64(f);
    const action = (type === "slip") ? "uploadSlip" : "uploadReceipt";
    const url = await uploadBase64(action, b64, f.type, f.name);
    urls.push(url);
    const chip = document.createElement("a");
    chip.className = "chip";
    chip.href = url;
    chip.target = "_blank";
    chip.innerHTML = `<i>🔗</i>${type === "slip" ? "ดูสลิป" : "ดูใบเสร็จ"}${files.length > 1 ? (" " + (i + 1)) : ""}`;
    chipsEl.appendChild(chip);
    bar.style.width = ((i + 1) / files.length * 100) + "%";
  }

  statusEl.textContent = "อัปโหลดเสร็จสิ้น ✅";
  setTimeout(() => { progress.style.display = "none"; bar.style.width = "0"; }, 1200);
  return urls;
}

document.getElementById("slipExpense").addEventListener("change", async (e) => {
  try {
    preUploaded.slips = await preUpload(e.target, "slip");
  } catch {
    document.getElementById("slipStatus").textContent = "❌ อัปโหลดล้มเหลว";
  }
});
document.getElementById("receiptExpense").addEventListener("change", async (e) => {
  try {
    preUploaded.receipts = await preUpload(e.target, "receipt");
  } catch {
    document.getElementById("receiptStatus").textContent = "❌ อัปโหลดล้มเหลว";
  }
});

/* ========== AMOUNT FORMAT (รองรับทศนิยม + แสดงบาทสตางค์) ========== */
const amountEl = document.getElementById("amount"), amountTxt = document.getElementById("amountTxt");
amountEl.addEventListener("input", () => {
  let s = amountEl.value.replace(/,/g, "").replace(/[^\d.]/g, "");
  const parts = s.split(".");
  if (parts.length > 2) s = parts[0] + "." + parts.slice(1).join("");
  const [intPart, decPart = ""] = s.split(".");
  const withCommas = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  amountEl.value = decPart ? withCommas + "." + decPart : withCommas;
  const num = parseFloat(s);
  if (!isNaN(num)) {
    const [i, d] = num.toFixed(2).split(".");
    amountTxt.textContent = "(" + thaiMoneyText(i, d) + ")";
  } else {
    amountTxt.textContent = "";
  }
});

amountEl.addEventListener("blur", () => {
  const raw = amountEl.value.replace(/,/g, "");
  const num = parseFloat(raw);
  if (!isNaN(num)) {
    amountEl.value = num.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const [i, d] = num.toFixed(2).split(".");
    amountTxt.textContent = "(" + thaiMoneyText(i, d) + ")";
  }
});

function thaiMoneyText(i, d) {
  const n = ["ศูนย์", "หนึ่ง", "สอง", "สาม", "สี่", "ห้า", "หก", "เจ็ด", "แปด", "เก้า"],
        p = ["", "สิบ", "ร้อย", "พัน", "หมื่น", "แสน", "ล้าน"];
  i = (i || "0").replace(/^0+/, "") || "0";
  let t = "", L = i.length;
  for (let k = 0; k < L; k++) {
    let x = parseInt(i[k]);
    if (x) {
      if (k == L - 1 && x == 1 && L > 1) t += "เอ็ด";
      else if (k == L - 2 && x == 2) t += "ยี่";
      else if (k == L - 2 && x == 1) t += "";
      else t += n[x];
      t += p[L - k - 1];
    }
  }
  if (!d || d === "00") return t + "บาทถ้วน";
  let s = "";
  if (d[0] !== "0") s += (d[0] === "1" ? "" : d[0] === "2" ? "ยี่" : n[+d[0]]) + "สิบ";
  if (d[1] !== "0") s += (d[1] === "1" ? "เอ็ด" : n[+d[1]]);
  return t + "บาท" + s + "สตางค์";
}
</script>
<!-- ======== END PART 6/7 ======== -->
<!-- ======== PART 7/7 (INIT + LOAD OPTIONS + STARTUP) ======== -->

<script>
/* ========== OPTIONS LOAD & BUILDING TAG SYSTEM ========== */
function fillSelect(id, arr) {
  const sel = document.getElementById(id);
  sel.innerHTML = `<option value="">-- เลือก --</option>` + (arr || []).map(v => `<option value="${v}">${v}</option>`).join("");
}

async function loadOptions() {
  try {
    const d = await fetch(API_URL).then(r => r.json());
    records = d.items || [];
    buildingList = d.options.buildings || [];

    fillSelect("supplierExpense", d.options.suppliers || []);
    fillSelect("project", d.options.projects || []);
    fillSelect("jobType", d.options.jobTypes || []);
    fillSelect("category", d.options.categories || []);
    fillSelect("paymentType", d.options.paymentTypes || []);

    renderHistory();
    renderDrill();
    setupBuildingSuggestions();
  } catch (err) {
    console.error("โหลดข้อมูลล้มเหลว:", err);
  }
}

/* ========== BUILDING TAG INPUT WITH SUGGESTION ========== */
function setupBuildingSuggestions() {
  const input = document.getElementById("buildingInput");
  let suggestionBox = document.createElement("div");
  suggestionBox.id = "buildingSuggestions";
  suggestionBox.style.cssText = `
    position:absolute;
    background:#fff;
    border:1px solid #ddd;
    border-radius:8px;
    box-shadow:0 3px 8px rgba(0,0,0,0.1);
    margin-top:2px;
    z-index:100;
    max-height:180px;
    overflow-y:auto;
    display:none;
  `;
  input.parentNode.style.position = "relative";
  input.parentNode.appendChild(suggestionBox);

  input.addEventListener("input", () => {
    const val = input.value.trim().toLowerCase();
    if (!val) { suggestionBox.style.display = "none"; return; }
    const filtered = buildingList.filter(b => b.toLowerCase().includes(val)).slice(0, 10);
    if (filtered.length === 0) { suggestionBox.style.display = "none"; return; }
    suggestionBox.innerHTML = filtered.map(b => `<div class="suggest-item">${b}</div>`).join("");
    suggestionBox.style.display = "block";

    suggestionBox.querySelectorAll(".suggest-item").forEach(item => {
      item.style.cssText = `
        padding:8px 10px;cursor:pointer;border-bottom:1px solid #eee;
      `;
      item.addEventListener("mouseenter", () => item.style.background = "#f1f5f9");
      item.addEventListener("mouseleave", () => item.style.background = "#fff");
      item.addEventListener("click", () => {
        if (!selectedBuildings.includes(item.textContent)) {
          selectedBuildings.push(item.textContent);
          renderBuildingTags();
        }
        input.value = "";
        suggestionBox.style.display = "none";
      });
    });
  });

  input.addEventListener("keydown", e => {
    if (e.key === "Enter" && input.value.trim() !== "") {
      e.preventDefault();
      const val = input.value.trim();
      if (!selectedBuildings.includes(val)) {
        selectedBuildings.push(val);
        renderBuildingTags();
      }
      input.value = "";
      suggestionBox.style.display = "none";
    }
  });

  document.addEventListener("click", e => {
    if (!input.parentNode.contains(e.target)) {
      suggestionBox.style.display = "none";
    }
  });
}

/* ========== ADD NEW BUILDING OPTION ========== */
document.getElementById("addBuildingBtn").addEventListener("click", async () => {
  const val = prompt("กรอกชื่ออาคารใหม่");
  if (val) {
    try {
      await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ addOption: { type: "Buildings", value: val } })
      });
      await loadOptions();
      if (!selectedBuildings.includes(val)) {
        selectedBuildings.push(val);
        renderBuildingTags();
      }
      alert("เพิ่มอาคารใหม่สำเร็จ ✅");
    } catch {
      alert("❌ เพิ่มอาคารล้มเหลว");
    }
  }
});

/* ========== INITIALIZE APP ========== */
window.addEventListener("DOMContentLoaded", async () => {
  setMode("เบิก");
  await loadOptions();
  renderBuildingTags();
});
</script>

<!-- ======== END PART 7/7 ======== -->
