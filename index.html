<!-- ======== PART 1/4: DOCTYPE + HEAD (Chart.js + Global Styles + Loader Spin only) ======== -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Satoshi Smart Ledger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Base */
    body{font-family:"Tahoma",Arial,sans-serif;margin:0;background:#f8f9fb;color:#333}
    .tabs{display:flex;background:#222}
    .tabs button{flex:1;padding:16px;border:none;background:#333;color:#bbb;cursor:pointer;transition:.2s}
    .tabs button.active{background:#B27A01;color:#fff;font-weight:700}
    .page{display:none;padding:20px}
    .page.active{display:block}
    .card{max-width:1140px;margin:20px auto;background:#fff;border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.1);padding:24px}
    h2{margin:0 0 16px;color:#222}
    label{display:block;margin-top:14px;font-weight:600;font-size:.95rem;color:#444}
    input,select{width:100%;padding:12px 14px;margin-top:6px;border:1px solid #ddd;border-radius:10px;font-size:1rem;box-sizing:border-box;background:#fafafa;transition:.2s}
    input:focus,select:focus{outline:none;border-color:#B27A01;background:#fff;box-shadow:0 0 0 2px rgba(178,122,1,.15)}
    .hint{font-size:.85rem;color:#64748b;margin-top:6px}
    .error{color:#d93025;font-size:.85rem;margin-top:4px;min-height:18px}
    .error-input{border-color:#d93025 !important}
    .toggle{display:flex;gap:12px;margin:18px 0}
    .toggle button{flex:1;padding:14px;border:none;border-radius:12px;background:#eee;color:#444;cursor:pointer;transition:.2s;font-size:1rem}
    .toggle button.selected{background:#B27A01;color:#fff;font-weight:600}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .full{grid-column:1/-1}
    .submit{margin-top:24px;width:100%;padding:15px;background:#333;color:#fff;border:none;border-radius:12px;cursor:pointer;font-size:1.05rem;font-weight:600;transition:.2s}
    .submit:hover{background:#B27A01}
    .amount-display{margin-top:6px;color:#777;font-style:italic}
    @media (max-width:780px){.row{grid-template-columns:1fr}}

    /* Buttons */
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;cursor:pointer}
    .btn-ok{border-color:#cbd5e1}
    .btn-success{border:none;background:#16a34a;color:#fff;font-weight:700;box-shadow:0 2px 6px rgba(22,163,74,.25)}
    .btn-success:hover{background:#15803d}
    .btn-apply{padding:8px 14px;border:none;border-radius:8px;background:#0ea5e9;color:#fff;font-weight:700;cursor:pointer}
    .btn-secondary{padding:8px 12px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;cursor:pointer}

    /* Loader (Spin only, no %) */
    #loaderOverlay{position:fixed;inset:0;background:rgba(0,0,0,.65);color:#fff;display:none;align-items:center;justify-content:center;z-index:3000;flex-direction:column;font-size:1.3rem;font-weight:600}
    #loaderSpinner{border:5px solid rgba(255,255,255,.2);border-top:5px solid #facc15;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;margin-bottom:16px}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Dashboard analytics */
    .analytics-wrap{margin-top:40px;display:grid;gap:30px}
    canvas{max-width:100%;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.05);padding:12px}
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loaderOverlay">
    <div id="loaderSpinner"></div>
    <div>กำลังโหลด...</div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-id="add">เพิ่มรายการ</button>
    <button class="tab" data-id="history">ประวัติ</button>
    <button class="tab" data-id="dashboard">แดชบอร์ด</button>
  </div>
  <!-- ADD PAGE -->
  <section id="add" class="page active">
    <div class="card">
      <h2>เพิ่มรายการ</h2>
      <div class="toggle">
        <button type="button" id="btnIncome">เบิก</button>
        <button type="button" id="btnExpense">จ่าย</button>
      </div>

      <form id="form" novalidate>
        <input type="hidden" id="mode">

        <div class="row">
          <div>
            <label>วันที่</label>
            <input type="date" id="date" required>
            <div class="error" id="err-date"></div>
          </div>
          <div id="itemWrap" class="expense-only" style="display:none">
            <label>รายละเอียด</label>
            <input type="text" id="item">
            <div class="error" id="err-item"></div>
          </div>
        </div>

        <div id="supplierExpenseWrap" class="full" style="display:none">
          <label>ร้านค้า</label>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="supplierExpense" style="flex:1"></select>
            <button type="button" id="addSupplierBtn" class="btn btn-success">+ เพิ่มร้านค้าใหม่</button>
          </div>
          <div class="error" id="err-supplierExpense"></div>
        </div>

        <div class="row expense-only" style="display:none">
          <div>
            <label>ชื่อโครงการ</label>
            <select id="project"></select>
            <div class="error" id="err-project"></div>
          </div>
          <div>
            <label>อาคาร</label>
            <div style="display:flex;gap:8px;align-items:flex-start">
              <div id="buildingTags" class="tag-input">
                <input type="text" id="buildingInput" placeholder="พิมพ์ชื่ออาคาร...">
                <div id="buildingSuggest" class="suggestion-list" style="display:none"></div>
              </div>
              <button type="button" id="addBuildingBtn" class="btn btn-success">+ เพิ่มอาคารใหม่</button>
            </div>
            <div class="hint">พิมพ์เพื่อค้นหา/เลือกจากรายการ หรือกด Enter เพื่อเพิ่ม</div>
            <div class="error" id="err-building"></div>
          </div>
        </div>

        <div class="row expense-only" style="display:none">
          <div>
            <label>ประเภทงาน</label>
            <select id="jobType"></select>
            <div class="error" id="err-jobType"></div>
          </div>
          <div>
            <label>หมวดงาน</label>
            <select id="category"></select>
            <div class="error" id="err-category"></div>
          </div>
        </div>

        <div class="row expense-only" style="display:none">
          <div class="full">
            <label>ประเภทรายการจ่าย</label>
            <select id="paymentType"></select>
            <div class="error" id="err-paymentType"></div>
          </div>
        </div>

        <div class="row expense-only" id="filesExpense" style="display:none">
          <div>
            <label>สลิป</label>
            <input type="file" id="slipExpense" multiple accept="image/*,.pdf">
            <div class="upload-row" id="slipStatusRow">
              <span class="upload-status" id="slipStatus">เตรียมอัปโหลดเมื่อกดบันทึก</span>
              <span id="slipChips"></span>
            </div>
          </div>
          <div>
            <label>ใบเสร็จ</label>
            <input type="file" id="receiptExpense" multiple accept="image/*,.pdf">
            <div class="upload-row" id="receiptStatusRow">
              <span class="upload-status" id="receiptStatus">เตรียมอัปโหลดเมื่อกดบันทึก</span>
              <span id="receiptChips"></span>
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>จำนวนเงิน</label>
            <input type="text" id="amount" required placeholder="ใส่ทศนิยมได้ เช่น 1234.56">
            <div id="amountTxt" class="amount-display"></div>
            <div class="error" id="err-amount"></div>
          </div>
          <div>
            <label>ผู้ดำเนินการ</label>
            <select id="operator" required>
              <option value="">-- เลือกผู้ดำเนินการ --</option>
              <option>ศุภกร เจิมจรุง</option>
              <option>กฤษณะ ทีมีศรี</option>
              <option>สรัญรุตม์ รอบคอบ</option>
              <option>เจทนิพัทธ์ อนุศาสนนันท์</option>
            </select>
            <div class="error" id="err-operator"></div>
          </div>
        </div>

        <button type="submit" id="submitBtn" class="submit">บันทึก</button>
      </form>
    </div>
  </section>

  <!-- HISTORY PAGE -->
  <section id="history" class="page">
    <div class="card">
      <h2>ประวัติการทำรายการ</h2>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
        <input type="date" id="historyStart" class="mini">
        <input type="date" id="historyEnd" class="mini">
        <button id="historyApply" class="btn-apply">กรองวันที่</button>
        <button id="exportPdf" class="btn-secondary">Export PDF</button>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px">
        <input type="text" id="searchBox" placeholder="ค้นหารายการ..." style="flex:2;padding:10px;border:1px solid #ccc;border-radius:8px">
        <select id="filterMode" style="flex:1;padding:10px;border:1px solid #ccc;border-radius:8px">
          <option value="">ทั้งหมด</option>
          <option value="เบิก">เบิก</option>
          <option value="จ่าย">จ่าย</option>
        </select>
        <select id="sortBy" style="flex:1;padding:10px;border:1px solid #ccc;border-radius:8px">
          <option value="date_desc">วันที่ (ใหม่→เก่า)</option>
          <option value="date_asc">วันที่ (เก่า→ใหม่)</option>
          <option value="amount_desc">จำนวนเงิน (มาก→น้อย)</option>
          <option value="amount_asc">จำนวนเงิน (น้อย→มาก)</option>
        </select>
      </div>

      <div id="historyList"></div>
      <div style="text-align:center;margin-top:12px">
        <button id="loadMoreBtn" class="btn btn-ok">โหลดเพิ่ม</button>
      </div>
    </div>
  </section>

  <!-- DASHBOARD PAGE -->
  <section id="dashboard" class="page">
    <div class="card">
      <h2>แดชบอร์ด</h2>
      <div class="filter-row">
        <input type="date" id="dbStart" class="mini">
        <input type="date" id="dbEnd" class="mini">
        <select id="dbPreset" class="mini">
          <option value="">ตั้งค่าช่วงเวลา</option>
          <option value="this_month">เดือนนี้</option>
          <option value="last_month">เดือนที่แล้ว</option>
          <option value="this_year">ปีนี้</option>
          <option value="last_year">ปีที่แล้ว</option>
        </select>
        <button id="dbReset" class="btn">ล้างตัวกรอง</button>
        <button id="exportChartPdf" class="btn">Export PDF</button>
      </div>

      <div class="crumbs" id="dbCrumbs"></div>
      <button class="btn btn-ok btn-back" id="dbBack" style="display:none">ย้อนกลับ</button>

      <div class="dash">
        <div id="donutWrap">
          <canvas id="donutChart"></canvas>
          <div id="centerText" class="center-text" style="display:none">
            <div class="big" id="centerBig">—</div>
            <div class="sub" id="centerSub">—</div>
          </div>
        </div>
        <div class="summary" id="summaryBox"></div>
      </div>

      <div class="analytics-wrap">
        <canvas id="barChart" height="200"></canvas>
        <canvas id="forecastChart" height="200"></canvas>
      </div>
    </div>
  </section>

  <!-- Popup + Modals -->
  <div id="popup"><div id="popupBox">กำลังบันทึก...</div></div>

  <div id="supplierModal" class="modal" aria-hidden="true">
    <div class="modal-box">
      <div class="modal-title">เพิ่มร้านค้าใหม่</div>
      <input type="text" id="supplierNewName" placeholder="เช่น หจก. ตัวอย่างการค้า">
      <div class="modal-actions">
        <button type="button" class="btn-cancel" data-close="#supplierModal">ยกเลิก</button>
        <button type="button" id="supplierSaveBtn" class="btn btn-success">บันทึก</button>
      </div>
    </div>
  </div>

  <div id="buildingModal" class="modal" aria-hidden="true">
    <div class="modal-box">
      <div class="modal-title">เพิ่มอาคารใหม่</div>
      <input type="text" id="buildingNewName" placeholder="เช่น อาคาร A">
      <div class="modal-actions">
        <button type="button" class="btn-cancel" data-close="#buildingModal">ยกเลิก</button>
        <button type="button" id="buildingSaveBtn" class="btn btn-success">บันทึก</button>
      </div>
    </div>
  </div>
<!-- ======== PART 3/4: SCRIPT – GLOBAL, TABS, VALIDATION, UPLOAD, HISTORY, DASHBOARD BASE ======== -->
<script>
const API_URL = "https://satoshi-smart-ledger.tttta2556.workers.dev/";
let records = [];
let chart = null;
let barChart = null;
let forecastChart = null;
let queuedUploads = { slips: [], receipts: [] };
let selectedBuildings = [];
let buildingList = [];

/* ===== Loader (no %) ===== */
const loader = document.getElementById("loaderOverlay");
function showLoader(){loader.style.display="flex"}
function hideLoader(){loader.style.display="none"}

/* ===== Popup ===== */
function showPopup(msg){document.getElementById("popupBox").textContent=msg;document.getElementById("popup").style.display="flex"}
function hidePopup(){document.getElementById("popup").style.display="none"}

/* ===== Tabs ===== */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.id).classList.add("active");
    if(btn.dataset.id==="history") renderHistory();
    if(btn.dataset.id==="dashboard") renderDashboard();
  });
});

/* ===== Mode toggle ===== */
function setMode(mode){
  document.getElementById("mode").value=mode;
  document.getElementById("btnIncome").classList.toggle("selected",mode==="เบิก");
  document.getElementById("btnExpense").classList.toggle("selected",mode==="จ่าย");
  const isIncome = mode==="เบิก";
  document.querySelectorAll(".expense-only").forEach(el=>el.style.display=isIncome?"none":"grid");
  document.getElementById("supplierExpenseWrap").style.display=isIncome?"none":"block";
  document.getElementById("filesExpense").style.display=isIncome?"none":"grid";
  document.getElementById("itemWrap").style.display=isIncome?"none":"block";
}
document.getElementById("btnIncome").addEventListener("click",()=>setMode("เบิก"));
document.getElementById("btnExpense").addEventListener("click",()=>setMode("จ่าย"));

/* ===== Building tags ===== */
function renderBuildingTags(){
  const box=document.getElementById("buildingTags");
  const input=document.getElementById("buildingInput");
  box.querySelectorAll(".tag").forEach(t=>t.remove());
  selectedBuildings.forEach((b,i)=>{
    const tag=document.createElement("div");
    tag.className="tag";
    tag.innerHTML=`${b} <button type="button" onclick="removeBuilding(${i})">×</button>`;
    box.insertBefore(tag,input);
  });
}
function removeBuilding(i){selectedBuildings.splice(i,1);renderBuildingTags();}

/* ===== Suggestions ===== */
function renderBuildingSuggestions(filter=""){
  const list=document.getElementById("buildingSuggest");
  list.innerHTML="";
  const filtered=buildingList.filter(b=>b.toLowerCase().includes(filter.toLowerCase())&&!selectedBuildings.includes(b)).slice(0,8);
  if(!filtered.length){list.style.display="none";return}
  filtered.forEach(b=>{
    const it=document.createElement("div");
    it.className="suggestion-item";
    it.textContent=b;
    it.onclick=()=>{selectedBuildings.push(b);renderBuildingTags();document.getElementById("buildingInput").value="";list.style.display="none";};
    list.appendChild(it);
  });
  list.style.display="block";
}
document.getElementById("buildingInput").addEventListener("input",e=>renderBuildingSuggestions(e.target.value.trim()));
document.getElementById("buildingInput").addEventListener("keydown",e=>{
  if(e.key==="Enter"&&e.target.value.trim()!==""){
    e.preventDefault();
    const v=e.target.value.trim();
    if(!selectedBuildings.includes(v)) selectedBuildings.push(v);
    e.target.value="";
    renderBuildingTags();
    document.getElementById("buildingSuggest").style.display="none";
  }
});
document.addEventListener("click",e=>{
  const box=document.getElementById("buildingTags");
  if(!box.contains(e.target)) document.getElementById("buildingSuggest").style.display="none";
});

/* ===== Add supplier/building modal ===== */
function openModal(id){document.querySelector(id).style.display="flex";}
function closeModal(id){document.querySelector(id).style.display="none";}
document.querySelectorAll(".btn-cancel").forEach(b=>b.onclick=()=>closeModal(b.dataset.close));
document.getElementById("addSupplierBtn").onclick=()=>openModal("#supplierModal");
document.getElementById("addBuildingBtn").onclick=()=>openModal("#buildingModal");

/* ===== Upload queue ===== */
function renderChips(type){
  const list=document.getElementById(type+"Chips");
  const arr = type==="slip"?queuedUploads.slips:queuedUploads.receipts;
  list.innerHTML="";
  arr.forEach(f=>{
    const c=document.createElement("span");
    c.className="chip";
    c.textContent=f.name;
    list.appendChild(c);
  });
}
document.getElementById("slipExpense").addEventListener("change",e=>{
  queuedUploads.slips=Array.from(e.target.files);
  renderChips("slip");
});
document.getElementById("receiptExpense").addEventListener("change",e=>{
  queuedUploads.receipts=Array.from(e.target.files);
  renderChips("receipt");
});

/* ===== Validation ===== */
function validateForm(){
  let ok=true;
  const m=document.getElementById("mode").value;
  const date=document.getElementById("date").value;
  const amount=parseFloat((document.getElementById("amount").value||"").replace(/,/g,""));
  const operator=document.getElementById("operator").value;
  if(!date){ok=false;document.getElementById("err-date").textContent="กรุณาเลือกวันที่";}
  if(!amount||isNaN(amount)){ok=false;document.getElementById("err-amount").textContent="กรอกจำนวนเงิน";}
  if(!operator){ok=false;document.getElementById("err-operator").textContent="เลือกผู้ดำเนินการ";}
  if(m==="จ่าย"){
    const need=["item","supplierExpense","project","jobType","category","paymentType"];
    need.forEach(id=>{const el=document.getElementById(id);if(!el.value){ok=false;document.getElementById("err-"+id).textContent="กรุณากรอกข้อมูล";}});
    if(selectedBuildings.length===0){ok=false;document.getElementById("err-building").textContent="เพิ่มอาคารอย่างน้อย 1 รายการ";}
  }
  return ok;
}

/* ===== History render ===== */
function formatDate(d){if(!d)return"";const dt=new Date(d);return dt.toLocaleDateString("th-TH",{year:"numeric",month:"2-digit",day:"2-digit"})}
function ymd(d){if(!d)return null;const dt=new Date(d);return dt.toISOString().slice(0,10);}
function renderHistory(){
  const list=document.getElementById("historyList");
  list.innerHTML="";
  const grouped={};
  records.forEach(r=>{
    const k=ymd(r.date)||"";
    if(!grouped[k]) grouped[k]=[];
    grouped[k].push(r);
  });
  Object.keys(grouped).sort((a,b)=>new Date(b)-new Date(a)).forEach(d=>{
    const header=document.createElement("div");
    header.className="date-header";
    header.textContent=formatDate(d);
    list.appendChild(header);
    grouped[d].forEach(r=>{
      const c=document.createElement("div");
      c.className="history-card";
      const sign=r.mode==="เบิก"?"+":"-";
      c.style.borderLeftColor=r.mode==="เบิก"?"#06c755":"#d93025";
      const money=`${sign}${Math.abs(r.amount||0).toLocaleString(undefined,{minimumFractionDigits:2})} บาท`;
      const slip=r.slips?'<a href="'+r.slips+'" target="_blank">ดูสลิป</a>':"-";
      const rec=r.receipts?'<a href="'+r.receipts+'" target="_blank">ดูใบเสร็จ</a>':"-";
      c.innerHTML=`
        <div class="history-top"><div>${r.id||"-"}</div><div class="history-amount ${r.mode==="เบิก"?"pos":"neg"}">${money}</div></div>
        <div class="history-one">${r.item||"-"}</div>
        <div class="history-operator">ผู้ดำเนินการ: ${r.operator||"-"}</div>
        <div class="history-detail">
          <div>โครงการ: ${r.project||"-"} | อาคาร: ${r.building||"-"}</div>
          <div>ประเภทงาน: ${r.jobType||"-"} | หมวดงาน: ${r.category||"-"}</div>
          <div>ประเภทรายการจ่าย: ${r.paymentType||"-"}</div>
          <div>สลิป: ${slip} | ใบเสร็จ: ${rec}</div>
        </div>`;
      c.onclick=()=>{const det=c.querySelector(".history-detail");det.style.display=det.style.display==="block"?"none":"block";};
      list.appendChild(c);
    });
  });
}

/* ===== Load & Refresh ===== */
async function loadOptions(){
  try{
    showLoader();
    const r=await fetch(API_URL);
    const d=await r.json();
    records=d.items||[];
    buildingList=d.options?.buildings||[];
    hideLoader();
    renderDashboard(); // auto-refresh dashboard
  }catch(err){
    console.error(err);
    hideLoader();
  }
}
<!-- ======== PART 4/4: DASHBOARD (Auto), Forecast/Analytics, Export PDF, Submit, Init ======== -->
<script>
/* ---------------------------------------
   🟠 Utilities for dashboard calculations
----------------------------------------*/
const THB = (v,fd=2)=>Number(v||0).toLocaleString(undefined,{minimumFractionDigits:fd,maximumFractionDigits:fd});
const ABS = n => Math.abs(Number(n)||0);

/* Parse within date range from dashboard inputs (auto-applied) */
function getDbRange(){
  const s = document.getElementById("dbStart")?.value || null;
  const e = document.getElementById("dbEnd")?.value || null;
  return {start:s, end:e};
}
function withinDbRange(d){
  const {start,end} = getDbRange();
  const y = ymd(d);
  if(!y) return false;
  if(start && y < start) return false;
  if(end   && y > end)   return false;
  return true;
}
function filteredForDashboard(){
  return records.filter(r=>withinDbRange(r.date));
}

/* ---------------------------------------
   🟣 Donut (Overview/Drill) — simplified
   - Fixed “เงินคงเหลือ” first
   - Center shows total withdrawn (เบิก) as THB
   - Legend shows % next to label (เหมือนเดิม)
   - Removed unit toggle
----------------------------------------*/
const drill = { level:0, path:[], dims:['project','building','jobType','category','paymentType'] };
let chart; // donut
function sumIncome(items){return items.filter(r=>r.mode==="เบิก").reduce((s,r)=>s+ABS(r.amount),0)}
function groupExpense(items,key){
  const m={};
  items.filter(r=>r.mode==="จ่าย").forEach(r=>{
    const k = (r[key]||"ไม่ระบุ").trim();
    m[k]=(m[k]||0)+ABS(r.amount);
  });
  return m;
}
function hashColorFromName(name){
  if(name==="เงินคงเหลือ") return "#4b5563";
  let h=0; for(let i=0;i<name.length;i++) h=(h*31+name.charCodeAt(i))>>>0;
  return `hsl(${h%360} 60% 55%)`;
}
function topNWithOthers(labels,values,N=6){
  const arr=labels.map((l,i)=>({l, v:values[i]})).sort((a,b)=>b.v-a.v);
  if(arr.length<=N) return {labels:arr.map(x=>x.l), values:arr.map(x=>x.v)};
  const top=arr.slice(0,N-1), others=arr.slice(N-1).reduce((s,x)=>s+x.v,0);
  return {labels:[...top.map(x=>x.l),"อื่นๆ"], values:[...top.map(x=>x.v), others]};
}
function setCenter(title,sub){
  const w=document.getElementById("centerText");
  document.getElementById("centerBig").textContent=title;
  document.getElementById("centerSub").textContent=sub||"";
  w.style.display="flex";
}
function renderDonut(labels,values,title){
  // เงินคงเหลือเป็นลำดับแรกเสมอ
  const idx = labels.indexOf("เงินคงเหลือ");
  if(idx>0){
    const [L]=labels.splice(idx,1);
    const [V]=values.splice(idx,1);
    labels=[L,...labels]; values=[V,...values];
  }
  // TopN
  const {labels:LL, values:VV} = topNWithOthers(labels,values,6);
  const total = VV.reduce((a,b)=>a+b,0);
  const colors = LL.map(l=>hashColorFromName(l));
  // Destroy old
  if(chart){ chart.destroy(); }
  const ctx=document.getElementById("donutChart").getContext("2d");
  chart=new Chart(ctx,{
    type:"doughnut",
    data:{labels:LL,datasets:[{data:VV,backgroundColor:colors}]},
    options:{
      responsive:true, cutout:"65%",
      plugins:{
        legend:{display:false},
        tooltip:{
          callbacks:{
            label:(c)=>{
              const val=Number(c.parsed)||0;
              const pct = total? (val/total*100):0;
              return `${c.label}: ${pct.toFixed(2)}%`;
            }
          }
        }
      },
      onClick:(evt)=>{
        const p=chart.getElementsAtEventForMode(evt,'nearest',{intersect:true},false);
        if(!p.length) return;
        const i=p[0].index; const label=LL[i];
        if(drill.level===0 && label==="เงินคงเหลือ") return;
        goDeeper(label);
      }
    }
  });

  // Summary (legend) — add (%) suffix on overview
  const box=document.getElementById("summaryBox");
  if(total<=0||LL.length===0){
    box.innerHTML=`<h3>${title}</h3><div class="legend-empty">ไม่มีข้อมูลในช่วงที่เลือก</div>`;
  }else{
    const isOverview = drill.level===0;
    const html = LL.map((l,i)=>{
      const v=VV[i]||0, pct= total? (v/total*100):0;
      const name = isOverview? `${l} (${pct.toFixed(2)}%)` : l;
      return `<div class="legend-item"><span class="legend-dot" style="background:${colors[i]}"></span><span>${name}</span><b style="margin-left:auto">${pct.toFixed(2)}%</b></div>`;
    }).join("");
    box.innerHTML=`<h3>${title}</h3>${html}`;
  }

  // Center text → total withdrawn (ภาพรวม)
  const all = filteredForDashboard();
  const totalIncome = sumIncome(all);
  setCenter(`${THB(totalIncome,0)}฿`,"ยอดเบิกรวมทั้งหมด");
}
function applyPath(items){
  let out=items.slice();
  drill.path.forEach(p=>{ out=out.filter(r=>(r[p.dim]||"ไม่ระบุ")===p.value && r.mode==="จ่าย");});
  return out;
}
function renderOverview(){
  const data=filteredForDashboard();
  const funds=sumIncome(data);
  const expenses=data.filter(r=>r.mode==="จ่าย");
  const byProject=groupExpense(expenses,"project");
  const spent=Object.values(byProject).reduce((s,v)=>s+v,0);
  const remain=Math.max(funds - spent, 0);
  const labels=["เงินคงเหลือ", ...Object.keys(byProject)];
  const values=[remain, ...Object.values(byProject)];
  renderDonut(labels,values,"ภาพรวม");
  renderCrumbs();
}
function renderDrill(){
  const data=filteredForDashboard();
  if(drill.level===0) return renderOverview();
  const scoped=applyPath(data);
  const dim=drill.dims[drill.level];
  const parentDim=drill.dims[drill.level-1];
  const parentVal=drill.path[drill.path.length-1]?.value || "";
  const by=groupExpense(scoped,dim);
  const labels=Object.keys(by), values=Object.values(by);
  renderDonut(labels,values,`${parentDim} ${parentVal} → ${dim}`);
  renderCrumbs();
}
function renderCrumbs(){
  const crumbs=document.getElementById("dbCrumbs");
  const back=document.getElementById("dbBack");
  const items=[{dim:"ภาพรวม",value:"ทั้งหมด"}].concat(drill.path);
  crumbs.innerHTML = items.map((p,i)=> i===0?`<span class="crumb">ภาพรวม</span>`:`<span class="crumb">${p.dim}: ${p.value}</span>`).join("");
  back.style.display = drill.level>0? "inline-block":"none";
}
function goDeeper(label){
  if(drill.level===0){drill.path.push({dim:'project', value:label});drill.level=1;}
  else{
    const dim=drill.dims[drill.level];
    drill.path.push({dim, value:label});
    if(drill.level<drill.dims.length-1) drill.level++;
  }
  renderDrill();
}
document.getElementById("dbBack").addEventListener("click",()=>{
  if(drill.level===0) return;
  drill.path.pop();
  drill.level=Math.max(0,drill.level-1);
  renderDrill();
});

/* ---------------------------------------
   🟡 Extra Analytics Charts:
   1) Cashflow (รายเดือน) — Line
   2) Top Spending (หมวดงาน) — Bar
   3) Forecast ค่าใช้จ่าย 3 เดือนถัดไป — Line (regression)
----------------------------------------*/
function monthKey(d){const dt=new Date(d);return `${dt.getFullYear()}-${("0"+(dt.getMonth()+1)).slice(-2)}`;}
function rangeMonthsAsc(allDates){ // unique sorted asc "YYYY-MM"
  const s=[...new Set(allDates)].sort((a,b)=>a.localeCompare(b));
  return s;
}
function monthlyRollup(items){
  const m={}; // {YYYY-MM: {in, out}}
  items.forEach(r=>{
    const k=monthKey(r.date);
    if(!m[k]) m[k]={in:0,out:0};
    if(r.mode==="เบิก") m[k].in += ABS(r.amount);
    else m[k].out += ABS(r.amount);
  });
  const keys=rangeMonthsAsc(Object.keys(m));
  return {keys, dataIn:keys.map(k=>m[k].in), dataOut:keys.map(k=>m[k].out)};
}
function ensureChartsDom(){
  // สร้าง canvas เพิ่มใต้ summary ถ้ายังไม่มี
  const container = document.querySelector(".dash");
  if(!document.getElementById("chartsColumn")){
    const col=document.createElement("div");
    col.id="chartsColumn";
    col.style.minWidth="300px";
    col.style.maxWidth="560px";
    col.style.flex="1";
    col.innerHTML=`
      <div class="summary" style="margin-top:0">
        <h3>Cashflow รายเดือน</h3>
        <canvas id="cashflowLine"></canvas>
      </div>
      <div class="summary" style="margin-top:16px">
        <h3>Top หมวดงานที่ใช้จ่าย</h3>
        <canvas id="topCategoryBar"></canvas>
      </div>
      <div class="summary" style="margin-top:16px">
        <h3>Forecast ค่าใช้จ่าย 3 เดือนถัดไป</h3>
        <canvas id="forecastLine"></canvas>
      </div>
    `;
    container.appendChild(col);
  }
}
function destroyChart(c){ if(c && typeof c.destroy==="function"){ try{c.destroy()}catch(_){}} }
function renderCashflowLine(){
  ensureChartsDom();
  const data=filteredForDashboard();
  const {keys, dataIn, dataOut} = monthlyRollup(data);
  const ctx=document.getElementById("cashflowLine").getContext("2d");
  destroyChart(window._cashflowLine);
  window._cashflowLine = new Chart(ctx,{
    type:"line",
    data:{labels:keys, datasets:[
      {label:"เบิกรวม/เดือน", data:dataIn, tension:0.25, fill:false},
      {label:"จ่ายรวม/เดือน", data:dataOut, tension:0.25, fill:false}
    ]},
    options:{responsive:true, plugins:{legend:{position:"bottom"}}}
  });
}
function renderTopCategoryBar(){
  ensureChartsDom();
  const data=filteredForDashboard();
  const by=groupExpense(data,"category");
  const labels=Object.keys(by);
  const values=Object.values(by);
  const combined = labels.map((l,i)=>({l,v:values[i]})).sort((a,b)=>b.v-a.v).slice(0,8);
  const L=combined.map(x=>x.l), V=combined.map(x=>x.v);
  const ctx=document.getElementById("topCategoryBar").getContext("2d");
  destroyChart(window._topCategoryBar);
  window._topCategoryBar = new Chart(ctx,{
    type:"bar",
    data:{labels:L, datasets:[{label:"ยอดใช้จ่าย", data:V}]},
    options:{responsive:true, plugins:{legend:{display:false}}, scales:{x:{ticks:{autoSkip:false}}}}
  });
}

/* --- Simple Linear Regression (least squares) for forecast --- */
function linRegForecast(x, y, steps=3){
  // x: [0..n-1], y: actual
  const n=x.length;
  if(n<2) return Array(steps).fill(y[n-1]||0);
  const sumX=x.reduce((a,b)=>a+b,0);
  const sumY=y.reduce((a,b)=>a+b,0);
  const sumXX=x.reduce((s,v)=>s+v*v,0);
  const sumXY=x.reduce((s,v,i)=>s+v*y[i],0);
  const denom = (n*sumXX - sumX*sumX) || 1;
  const a = (n*sumXY - sumX*sumY)/denom; // slope
  const b = (sumY - a*sumX)/n;          // intercept
  const out=[];
  for(let i=0;i<steps;i++){
    const xi = n+i;
    out.push(a*xi + b);
  }
  return out.map(v=>Math.max(0, v)); // ไม่ให้ติดลบ
}
function nextMonthStr(ym){ // "YYYY-MM" -> next "YYYY-MM"
  const [Y,M]=ym.split("-").map(Number);
  let y=Y, m=M+1; if(m>12){m=1;y++}
  return `${y}-${("0"+m).slice(-2)}`;
}
function forecast3MonthsLabels(lastYM){
  const a = nextMonthStr(lastYM);
  const b = nextMonthStr(a);
  const c = nextMonthStr(b);
  return [a,b,c];
}
function renderForecast(){
  ensureChartsDom();
  const data=filteredForDashboard().filter(r=>r.mode==="จ่าย");
  // monthly expense totals
  const m={}; data.forEach(r=>{const k=monthKey(r.date); m[k]=(m[k]||0)+ABS(r.amount);});
  const keys = rangeMonthsAsc(Object.keys(m));
  if(!keys.length){
    const ctx=document.getElementById("forecastLine").getContext("2d");
    destroyChart(window._forecastLine);
    window._forecastLine = new Chart(ctx,{type:"line",data:{labels:[],datasets:[{label:"Forecast",data:[]}]},options:{plugins:{legend:{display:false}}}});
    return;
  }
  const y = keys.map(k=>m[k]);
  const x = keys.map((_,i)=>i);
  const f3 = linRegForecast(x,y,3);
  const fLabels = forecast3MonthsLabels(keys[keys.length-1]);
  const ctx=document.getElementById("forecastLine").getContext("2d");
  destroyChart(window._forecastLine);
  window._forecastLine = new Chart(ctx,{
    type:"line",
    data:{
      labels:[...keys, ...fLabels],
      datasets:[
        {label:"จ่ายจริง (ต่อเดือน)", data:y, tension:0.25, fill:false},
        {label:"คาดการณ์ 3 เดือนถัดไป", data:[...Array(y.length).fill(null), ...f3], tension:0.25, borderDash:[6,6], fill:false}
      ]
    },
    options:{responsive:true, plugins:{legend:{position:"bottom"}}}
  });
}

/* ---------------------------------------
   🟢 Dashboard orchestrator (Auto-refresh)
   - No more “นำไปใช้”
   - Updates on date/preset change automatically
----------------------------------------*/
function renderDashboard(){
  // ลบปุ่ม “นำไปใช้” และ “ดูเป็น % / ดูเป็น บาท” ถ้ามีอยู่ใน DOM เดิม
  const applyBtn=document.getElementById("dbApply"); if(applyBtn) applyBtn.style.display="none";
  const toggleBtn=document.getElementById("toggleUnit"); if(toggleBtn) toggleBtn.style.display="none";

  // รักษาสภาพ drill เดิมเมื่อ refresh
  if(drill.level===0) renderOverview(); else renderDrill();

  // กราฟเสริม
  renderCashflowLine();
  renderTopCategoryBar();
  renderForecast();
}

/* Auto-apply on date / preset changes */
function hookDashboardFilters(){
  const startEl=document.getElementById("dbStart");
  const endEl=document.getElementById("dbEnd");
  const preset=document.getElementById("dbPreset");
  if(preset){
    preset.addEventListener("change",()=>{
      const t=new Date();
      let s=null,e=null;
      if(preset.value==="this_month"){
        s=new Date(t.getFullYear(),t.getMonth(),1);
        e=new Date(t.getFullYear(),t.getMonth()+1,0);
      }else if(preset.value==="last_month"){
        s=new Date(t.getFullYear(),t.getMonth()-1,1);
        e=new Date(t.getFullYear(),t.getMonth(),0);
      }else if(preset.value==="this_year"){
        s=new Date(t.getFullYear(),0,1); e=new Date(t.getFullYear(),11,31);
      }else if(preset.value==="last_year"){
        const y=t.getFullYear()-1; s=new Date(y,0,1); e=new Date(y,11,31);
      }
      if(s){startEl.value=s.toISOString().slice(0,10)}
      if(e){endEl.value=e.toISOString().slice(0,10)}
      // reset drill when preset changed
      drill.level=0; drill.path=[];
      renderDashboard();
    });
  }
  const onDateChange = ()=>{ drill.level=0; drill.path=[]; renderDashboard(); };
  startEl && startEl.addEventListener("change", onDateChange);
  endEl && endEl.addEventListener("change", onDateChange);

  // Reset filters
  const resetBtn=document.getElementById("dbReset");
  if(resetBtn){
    resetBtn.addEventListener("click",()=>{
      startEl.value=""; endEl.value=""; preset.value="";
      drill.level=0; drill.path=[];
      renderDashboard();
    });
  }
}

/* ---------------------------------------
   📄 Export Dashboard to PDF window
   - รวมภาพ Donut + Cashflow + TopCategory + Forecast
----------------------------------------*/
function exportDashboardPdf(){
  const win=window.open("","_blank");
  const donut = document.getElementById("donutChart").toDataURL("image/png");
  const cash  = document.getElementById("cashflowLine")?.toDataURL("image/png") || "";
  const bar   = document.getElementById("topCategoryBar")?.toDataURL("image/png") || "";
  const fore  = document.getElementById("forecastLine")?.toDataURL("image/png") || "";
  const {start,end}=getDbRange();
  const startTxt = start? formatDate(start) : "-";
  const endTxt   = end? formatDate(end)     : "-";
  const legendHtml = document.getElementById("summaryBox").innerHTML;

  const html = `
  <html><head><meta charset="utf-8"><title>Dashboard Export</title>
  <style>
    body{font-family:Tahoma,Arial,sans-serif;margin:22px}
    h2{margin:0 0 8px}
    h3{margin:18px 0 8px}
    .meta{color:#475569;margin-bottom:10px}
    img{max-width:780px;display:block;margin:8px 0}
    .legend .legend-item{display:flex;align-items:center;gap:8px;margin:6px 0}
    .legend .legend-dot{width:12px;height:12px;border-radius:50%}
  </style></head><body>
    <h2>แดชบอร์ด</h2>
    <div class="meta">ช่วงวันที่: ${startTxt} - ${endTxt}</div>
    <h3>สัดส่วนค่าใช้จ่าย (Donut)</h3>
    <img src="${donut}" alt="donut">
    <div class="legend">${legendHtml}</div>
    ${cash?`<h3>Cashflow รายเดือน</h3><img src="${cash}" alt="cashflow">`:``}
    ${bar?`<h3>Top หมวดงานที่ใช้จ่าย</h3><img src="${bar}" alt="top-category">`:``}
    ${fore?`<h3>Forecast 3 เดือนข้างหน้า</h3><img src="${fore}" alt="forecast">`:``}
  </body></html>`;
  win.document.write(html); win.document.close(); win.focus(); win.print();
}
/* bind export button (if exists in DOM) */
(function bindExport(){
  const btn=document.getElementById("exportChartPdf");
  if(btn){
    btn.addEventListener("click",exportDashboardPdf);
  }
})();

/* ---------------------------------------
   💾 Submit + Upload (ชื่อไฟล์ = ID กลาง)
----------------------------------------*/
function uuid(){
  const t=Date.now().toString(36);
  const r=Math.random().toString(36).slice(2,8);
  return `LEDGER-${t}-${r}`.toUpperCase();
}
function fileToBase64(file){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result.split(",")[1]);fr.onerror=rej;fr.readAsDataURL(file)})}
async function uploadFixed(action, base64, mimeType, filename){
  const r=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action,data:base64,mimeType,filename})});
  const j=await r.json(); if(!j.ok) throw new Error("upload failed"); return j.url;
}
document.getElementById("form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(!validateForm()) return;
  showPopup("กำลังบันทึกไฟล์...");
  try{
    const mode=document.getElementById("mode").value;
    const date=document.getElementById("date").value;
    const amount=parseFloat((document.getElementById("amount").value||"").replace(/,/g,""));
    const operator=document.getElementById("operator").value;
    const buildings=selectedBuildings.slice();
    const sharedId = uuid();

    // Upload files (ชื่อไฟล์ = sharedId, ถ้ามีหลายไฟล์ เติม -S1 / -R1)
    const slipUrls=[], receiptUrls=[];
    for(let i=0;i<queuedUploads.slips.length;i++){
      const f=queuedUploads.slips[i];
      const b64=await fileToBase64(f);
      const name = (queuedUploads.slips.length===1)? sharedId : `${sharedId}-S${i+1}`;
      slipUrls.push(await uploadFixed("uploadSlip", b64, f.type, name));
    }
    for(let i=0;i<queuedUploads.receipts.length;i++){
      const f=queuedUploads.receipts[i];
      const b64=await fileToBase64(f);
      const name = (queuedUploads.receipts.length===1)? sharedId : `${sharedId}-R${i+1}`;
      receiptUrls.push(await uploadFixed("uploadReceipt", b64, f.type, name));
    }

    // Payloads (แชร์ลิงก์เดียวกันทุกอาคาร)
    const split = (mode==="จ่าย" && buildings.length>0) ? (amount/buildings.length) : amount;
    const payloads=[];
    if(mode==="จ่าย" && buildings.length>0){
      for(const b of buildings){
        payloads.push({
          id:sharedId, mode, date,
          item:document.getElementById("item").value,
          supplier:document.getElementById("supplierExpense").value,
          project:document.getElementById("project").value,
          building:[b],
          jobType:document.getElementById("jobType").value,
          category:document.getElementById("category").value,
          paymentType:document.getElementById("paymentType").value,
          amount:-Math.abs(split),
          operator,
          slips:slipUrls.join(","),
          receipts:receiptUrls.join(",")
        });
      }
    }else{
      payloads.push({
        id:sharedId, mode, date,
        item:(mode==="จ่าย")?document.getElementById("item").value:"",
        supplier:(mode==="จ่าย")?document.getElementById("supplierExpense").value:"",
        project:(mode==="จ่าย")?document.getElementById("project").value:"",
        building:(mode==="จ่าย")?buildings:[],
        jobType:(mode==="จ่าย")?document.getElementById("jobType").value:"",
        category:(mode==="จ่าย")?document.getElementById("category").value:"",
        paymentType:(mode==="จ่าย")?document.getElementById("paymentType").value:"",
        amount:(mode==="จ่าย")?-Math.abs(amount):Math.abs(amount),
        operator,
        slips:slipUrls.join(","),
        receipts:receiptUrls.join(",")
      });
    }

    showPopup(`กำลังบันทึกข้อมูล (${payloads.length} รายการ)...`);
    for(const p of payloads){
      const r=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});
      const j=await r.json(); if(!j.ok) throw new Error("save failed");
    }
    showPopup("บันทึกสำเร็จ");

    // Reset form
    setTimeout(hidePopup,900);
    document.getElementById("form").reset();
    queuedUploads={slips:[],receipts:[]};
    document.getElementById("slipChips").innerHTML="";
    document.getElementById("receiptChips").innerHTML="";
    selectedBuildings=[]; renderBuildingTags();
    setMode("เบิก");

    // Reload data + auto refresh dashboard/history
    await loadOptions();
    renderHistory();
    renderDashboard();
  }catch(err){
    console.error(err);
    showPopup("เกิดข้อผิดพลาดในการบันทึก"); setTimeout(hidePopup,1400);
  }
});

/* ---------------------------------------
   ⏫ Save new Supplier / Building
----------------------------------------*/
document.getElementById("supplierSaveBtn").addEventListener("click", async ()=>{
  const val=(document.getElementById("supplierNewName").value||"").trim();
  if(!val) return;
  showPopup("กำลังเพิ่มร้านค้า...");
  try{
    await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({addOption:{type:"Suppliers",value:val}})});
    await loadOptions();
    document.getElementById("supplierExpense").value=val;
    hidePopup(); closeModal("#supplierModal");
  }catch(e){ hidePopup(); alert("เพิ่มร้านค้าไม่สำเร็จ"); }
});
document.getElementById("buildingSaveBtn").addEventListener("click", async ()=>{
  const val=(document.getElementById("buildingNewName").value||"").trim();
  if(!val) return;
  showPopup("กำลังเพิ่มอาคาร...");
  try{
    await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({addOption:{type:"Buildings",value:val}})});
    await loadOptions();
    if(!selectedBuildings.includes(val)){selectedBuildings.push(val);renderBuildingTags()}
    hidePopup(); closeModal("#buildingModal");
  }catch(e){ hidePopup(); alert("เพิ่มอาคารไม่สำเร็จ"); }
});

/* ---------------------------------------
   🚀 INIT
----------------------------------------*/
async function init(){
  setMode("เบิก");
  hookDashboardFilters();
  showLoader();
  await loadOptions();  // โหลดข้อมูล + renderDashboard จากใน loadOptions แล้ว
  hideLoader();
  renderHistory();
}
window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
<!-- ======== END PART 4/4 ======== -->
